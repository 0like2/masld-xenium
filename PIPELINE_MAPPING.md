# íŒŒì´í”„ë¼ì¸ ë§¤í•‘: ì‚¬ìš©ì í”Œë¡œìš°ì°¨íŠ¸ vs í˜„ì¬ êµ¬í˜„

ì´ ë¬¸ì„œëŠ” ì‚¬ìš©ìì˜ 4ë‹¨ê³„ í”Œë¡œìš°ì°¨íŠ¸ì™€ í˜„ì¬ Xenium íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ë‹¨ê³„ ê°„ì˜ ëŒ€ì‘ ê´€ê³„ë¥¼ ì •ë¦¬í•œ ê²ƒì…ë‹ˆë‹¤. ëª¨ë“  ë‹¨ê³„ì˜ ìƒì„¸ ê¸°ìˆ  ì‚¬ì–‘(ì•Œê³ ë¦¬ì¦˜, ìˆ˜ì‹, ë¼ì´ë¸ŒëŸ¬ë¦¬)ì„ í¬í•¨í•©ë‹ˆë‹¤.

## ê°œìš” (Overview)

| **ì‚¬ìš©ì í”Œë¡œìš°ì°¨íŠ¸ ë‹¨ê³„** | **í˜„ì¬ íŒŒì´í”„ë¼ì¸ ë‹¨ê³„** | **ì„¤ëª…** |
| :--- | :--- | :--- |
| **1. Data Loading & QC** | **Step 0 & Step 1.1** | ë°ì´í„° ë¡œë”© ë° í’ˆì§ˆ í•„í„°ë§ (`min_counts`, `min_genes`) |
| **3. Preprocessing** | **Step 1.2** | ì •ê·œí™”, ë¡œê·¸ ë³€í™˜, ì°¨ì› ì¶•ì†Œ ë° í´ëŸ¬ìŠ¤í„°ë§ |
| **2. Cell Segmentation & Assignment** | **Step 2, 4, 5** | ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ë¶„ì„, í• ë‹¹ ê²½ê³„ ìµœì í™”, ì„¸ê·¸ë©˜í…Œì´ì…˜ ì„±ëŠ¥ ê²€ì¦ |
| **4. SVF Feature Selection** | **Step 8** | ê³µê°„ ë³€ì´ ìœ ì „ì(SVF) ì„ ë³„ (Moran's I) |

---

## ğŸ”¬ ìƒì„¸ ê¸°ìˆ  ë¶„ì„ (Detailed Technical Reference)

### 1. Data Loading & QC (ì‚¬ìš©ì Step 1 - ë°ì´í„° ë¡œë”© ë° í’ˆì§ˆ í•„í„°ë§)
*   **ë§¤í•‘ ë‹¨ê³„**: `Step 0` & `Step 1.1`
*   **ëª©ì **: ì›ë³¸ ë°ì´í„° ë¡œë“œ ë° ì €í’ˆì§ˆ ì„¸í¬ ì œê±°
*   **ğŸ“‚ ìƒì„± íŒŒì¼ (Outputs)**
    *   `{tag}_step1_qc_violin.png` â€“ QC ì§€í‘œ ë°”ì´ì˜¬ë¦° í”Œë¡¯ (í•„í„°ë§ ì „í›„ ë¹„êµ)
    *   í•„í„°ë§ëœ AnnData ê°ì²´ (ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „ë‹¬)

#### ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­ (Technical Specs)

##### 1.1 Quality Control (QC) í•„í„°ë§
**í•¨ìˆ˜**: `xb.preprocessing.main_preprocessing()` (ë¼ì¸ 17-95)
**êµ¬í˜„ ì½”ë“œ**:
```python
sc.pp.filter_cells(adata, min_counts=mincounts)  # mincounts=10 (ê¸°ë³¸ê°’)
sc.pp.filter_cells(adata, min_genes=mingenes)    # mingenes=3 (ê¸°ë³¸ê°’)
```

**í•„í„°ë§ ê¸°ì¤€ (Thresholds)**:
| íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|:---|:---:|:---|
| **Min Counts** | 10 | ì´ ì „ì‚¬ì²´(transcript) ìˆ˜ í•„í„°. Empty droplets, debris ê°™ì€ ì €í’ˆì§ˆ ì„¸í¬ ì œê±° |
| **Min Genes** | 3 | ë°œí˜„ëœ ì„œë¡œ ë‹¤ë¥¸ ìœ ì „ì ì¢…ë¥˜ ìˆ˜ í•„í„°. ê·¹íˆ ì €í’ˆì§ˆ ì„¸í¬ ì œê±° |

**ì›ë¦¬**:
- `min_counts`: ê° ì„¸í¬ì˜ ì „ì²´ UMI ìˆ˜ í•©ê³„ê°€ ì„ê³„ê°’ ì´ìƒì´ì–´ì•¼ í•¨
- `min_genes`: ê° ì„¸í¬ì—ì„œ ë°œí˜„ëœ **ì„œë¡œ ë‹¤ë¥¸** ìœ ì „ìì˜ ê°œìˆ˜ê°€ ì„ê³„ê°’ ì´ìƒì´ì–´ì•¼ í•¨

**QV Score (Quality Value / Q-Phred Score)**:
*   **ì„¤ëª…**: Xeniumì—ì„œ ê° ë¦¬ë“œ(read)ì˜ í’ˆì§ˆ ì ìˆ˜. QV ë° QPëŠ” ë™ì¼í•œ ê°œë….
*   **ê³„ì‚°**: QV = -10 Ã— logâ‚â‚€(Error Rate)
    - QV > 20 â†’ 99% ì •í™•ë„ ì´ìƒ
    - QV > 30 â†’ 99.9% ì •í™•ë„ ì´ìƒ
*   **ë™ì‘ ë°©ì‹**: í˜„ì¬ íŒŒì´í”„ë¼ì¸ì€ `QV > 20`ì¸ ë¦¬ë“œì˜ ë¹„ìœ¨ì„ **ëª¨ë‹ˆí„°ë§**ë§Œ ìˆ˜í–‰ (ê²½ê³  ë¡œê·¸ ê¸°ë¡). ìë™ í•„í„°ë§ì€ í•˜ì§€ ì•ŠìŒ.
    - ì´ìœ : Xenium ê¸°ê¸° ìì²´ì—ì„œ ì´ë¯¸ 1ì°¨ í•„í„°ë§ëœ ë°ì´í„° ì œê³µ

---

### 3. Preprocessing (ì‚¬ìš©ì Step 3 - ì •ê·œí™” ~ í´ëŸ¬ìŠ¤í„°ë§)
*   **ë§¤í•‘ ë‹¨ê³„**: `Step 1.2` (ë©”ì¸ íŒŒì´í”„ë¼ì¸ì—ì„œëŠ” step1_preprocessì˜ [1-2] ë‹¨ê³„)
*   **ëª©ì **: QC í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ë¶„ì„ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜ ë° í´ëŸ¬ìŠ¤í„°ë§
*   **ğŸ“‚ ìƒì„± íŒŒì¼ (Outputs)**
    *   `{tag}_step1_preprocessed.h5ad` â€“ ì „ì²˜ë¦¬ ì™„ë£Œëœ AnnData ê°ì²´
    *   `{tag}_step1_pca_plot.png` â€“ PCA ì‹œê°í™”
    *   `{tag}_step1_pca_variance.png` â€“ PCA ë¶„ì‚° ì„¤ëª…ë ¥ í”Œë¡¯
    *   `{tag}_step1_umap_plot.png` â€“ UMAP í´ëŸ¬ìŠ¤í„°ë§ ê²°ê³¼
    *   `{tag}_step1_marker_genes_dotplot.png` â€“ ë§ˆì»¤ ìœ ì „ì ë°œí˜„ dot plot
    *   `{tag}_step1_marker_genes.csv` â€“ ë§ˆì»¤ ìœ ì „ì ì •ë³´ í…Œì´ë¸”

#### ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­ (Technical Specs)

##### 3.1 ì •ê·œí™” (Normalization)
**í•¨ìˆ˜**: `sc.pp.normalize_total()`
**êµ¬í˜„ ì½”ë“œ** (`xb/preprocessing.py` ë¼ì¸ 48):
```python
sc.pp.normalize_total(adata, target_sum=target_sum)  # target_sum=100
```

**íŒŒë¼ë¯¸í„° ìƒì„¸**:
| íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|:---|:---:|:---|
| `target_sum` | 100 | ê° ì„¸í¬ì˜ ì •ê·œí™” ëª©í‘œê°’. (ê¸°ë³¸ scRNA-seqëŠ” 10,000 ì‚¬ìš©, Xeniumì€ ë‚®ì€ count íŠ¹ì„±ìƒ 100 ê¶Œì¥) |

**ê³„ì‚° ê³µì‹**:
$$X_{normalized}[i,j] = \frac{X_{raw}[i,j]}{\sum_k X_{raw}[i,k]} \times \text{target\_sum}$$

- ë¶„ì: ì›ë³¸ ì¹´ìš´íŠ¸
- ë¶„ëª¨: í•´ë‹¹ ì„¸í¬ì˜ ì „ì²´ ì¹´ìš´íŠ¸ í•© (Library Size)
- ê²°ê³¼: ì„¸í¬ ê°„ ì‹œí€€ì‹± ê¹Šì´ ì°¨ì´ ì œê±°

**ì´ìœ **: Xeniumì€ scRNA-seq ëŒ€ë¹„ ì „ì‚¬ì²´ ì¹´ìš´íŠ¸ê°€ ë§¤ìš° ë‚®ìœ¼ë¯€ë¡œ, target_sum=100 ì‚¬ìš© (ë…¼ë¬¸ ê¶Œì¥)

##### 3.2 ë¡œê·¸ ë³€í™˜ (Log Transformation)
**í•¨ìˆ˜**: `sc.pp.log1p()`
**êµ¬í˜„ ì½”ë“œ** (`xb/preprocessing.py` ë¼ì¸ 50):
```python
sc.pp.log1p(adata)  # Log(x+1) ë³€í™˜
```

**ê³„ì‚° ê³µì‹**:
$$X_{log}[i,j] = \log_e(X_{norm}[i,j] + 1)$$

**ëª©ì **:
- ì •ê·œí™”ëœ ì¹´ìš´íŠ¸ ë°ì´í„°ì˜ ë¶„í¬ë¥¼ ì •ê·œë¶„í¬ì— ë” ê°€ê¹ê²Œ ë§Œë“¦
- ê³ ë°œí˜„ ìœ ì „ìì˜ ì˜í–¥ì„ ê°ì†Œ
- ì €ë°œí˜„ ìœ ì „ìì™€ ê³ ë°œí˜„ ìœ ì „ì ê°„ scale ì°¨ì´ ì™„í™”

**+1 ì´ìœ **: log(0)ì„ í”¼í•˜ê¸° ìœ„í•´ ëª¨ë“  ê°’ì— 1ì„ ë”í•œ í›„ ë¡œê·¸ ë³€í™˜

##### 3.3 ìŠ¤ì¼€ì¼ë§ (Scaling) â€“ **ë¹„í™œì„±í™”**
**ì„¤ì •** (`xb/preprocessing.py` ë¼ì¸ 54-55):
```python
if scale==True:
    sc.pp.scale(adata)  # ê¸°ë³¸ê°’: scale=False
```

**ê²°ì • ì´ìœ **:
- **ë¹„í™œì„±í™” ì´ìœ **: ê³µê°„ ì „ì‚¬ì²´ ë°ì´í„°ëŠ” ë…¸ì´ì¦ˆê°€ ë§ìœ¼ë¯€ë¡œ, ìŠ¤ì¼€ì¼ë§ì´ ì˜¤íˆë ¤ ë…¸ì´ì¦ˆë¥¼ ì¦í­ì‹œí‚¬ ìˆ˜ ìˆìŒ
- ì¼ë°˜ì ìœ¼ë¡œ ê³µê°„ ë°ì´í„° ë¶„ì„ ì‹œ ìŠ¤ì¼€ì¼ë§ ìƒëµ (ë…¼ë¬¸ ê¶Œì¥)

##### 3.4 ì°¨ì› ì¶•ì†Œ (PCA)
**í•¨ìˆ˜**: `sc.pp.pca()`
**êµ¬í˜„ ì½”ë“œ** (`xb/preprocessing.py` ë¼ì¸ 56):
```python
sc.pp.pca(adata)  # ê¸°ë³¸ê°’: n_comps=50
```

**ëª©ì **:
- ê³ ì°¨ì› ìœ ì „ì ë°œí˜„ ë°ì´í„°ë¥¼ ì €ì°¨ì›ìœ¼ë¡œ ì¶•ì†Œ (ë…¸ì´ì¦ˆ ì œê±°)
- ì´ì›ƒ ê·¸ë˜í”„ êµ¬ì„± ì‹œ ê³„ì‚° íš¨ìœ¨ ì¦ëŒ€

##### 3.5 í´ëŸ¬ìŠ¤í„°ë§ (Clustering)
**ì•Œê³ ë¦¬ì¦˜**: Leiden Algorithm
**êµ¬í˜„ ì½”ë“œ** (`xb/preprocessing.py` ë¼ì¸ 58-60):
```python
sc.pp.neighbors(adata, n_neighbors=neigh, n_pcs=npc)  # neigh=15, npc=20
sc.tl.leiden(adata, resolution=resol)  # resol=1.4 (ê¸°ë³¸ê°’)
```

**ë‹¨ê³„ë³„ ì„¤ëª…**:

| ë‹¨ê³„ | í•¨ìˆ˜ | íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|:---|:---|:---|:---:|:---|
| 1 | `neighbors()` | `n_neighbors` | 15 | k-NN ê·¸ë˜í”„ì—ì„œ ê° ì„¸í¬ì˜ ì´ì›ƒ ê°œìˆ˜ |
| 1 | `neighbors()` | `n_pcs` | 20 | PCAì—ì„œ ì‚¬ìš©í•  ì£¼ì„±ë¶„ ê°œìˆ˜ (ê¸°ë³¸=0ì€ ì „ë¶€ ì‚¬ìš©) |
| 2 | `leiden()` | `resolution` | 1.4 | Leiden í´ëŸ¬ìŠ¤í„°ë§ì˜ í•´ìƒë„ íŒŒë¼ë¯¸í„° (í´ìˆ˜ë¡ ë” ë§ì€ í´ëŸ¬ìŠ¤í„°) |

**Leiden vs Louvain**:
- í˜„ì¬ êµ¬í˜„: **Leiden** (ë” ë¹ ë¥´ê³  ì•ˆì •ì )
- ì½”ë“œ ì£¼ì„: "Fallback: Using Leiden instead of Louvain" (Louvain ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± ì œê±°)

**ëª©í‘œ í´ëŸ¬ìŠ¤í„° ê°œìˆ˜ ì¡°ì •** (`xb/preprocessing.py` ë¼ì¸ 59-76):
- `default=True`: target_clustersì— ë§ì¶° resolution ìë™ ì¡°ì •
- resolution ì¦ê°ì„ ë°˜ë³µí•˜ì—¬ ëª©í‘œ ê°œìˆ˜ Â±3 ë²”ìœ„ ë‚´ ë„ë‹¬

##### 3.6 ë§ˆì»¤ ìœ ì „ì ì‹ë³„
**í•¨ìˆ˜**: `sc.tl.rank_genes_groups()`
**êµ¬í˜„** (ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ):
```python
sc.tl.rank_genes_groups(adata, groupby='leiden_cluster', method='wilcoxon')
```

**ëª©ì **: ê° í´ëŸ¬ìŠ¤í„°ë³„ ëŒ€í‘œ ìœ ì „ì(ë§ˆì»¤) ì‹ë³„

### 2. Cell Segmentation & Assignment (ì‚¬ìš©ì Step 2)
*   **ë§¤í•‘ ë‹¨ê³„**: `Step 2`, `Step 2.3 (Overlaps)`, `Step 2.4 (SSAM)`, `Step 4`, `Step 5`
*   **ğŸ“‚ ìƒì„± íŒŒì¼ (Outputs)**
    *   `{tag}_step2_gene_distances.csv` â€“ ê° ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ì •ë³´
    *   `{tag}_step2_gene_dist_plot.png` â€“ ê±°ë¦¬ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨
    *   `{tag}_step2_gene_dist_boxplot.png` â€“ ê±°ë¦¬ ë¶„í¬ ë°•ìŠ¤í”Œë¡¯
    *   `{tag}_step2_reads_sample.parquet` â€“ ì „ì‚¬ì²´ ìƒ˜í”Œ (ê³„ì‚° íš¨ìœ¨ì„±)
    *   `step2_overlaps/z_range_distribution.png` â€“ Zì¶• ë²”ìœ„ ë¶„í¬
    *   `step2_overlaps/cell_z_stats.csv` â€“ ì„¸í¬ë³„ Zì¶• í†µê³„
    *   `step2_ssam/transcript_density_map.png` â€“ SSAM ê¸°ë°˜ ì „ì‚¬ì²´ ë°€ë„ ë§µ
    *   `{tag}_step4_optimal_expansion.csv` â€“ ìµœì  í™•ì¥ ê±°ë¦¬ ê²°ê³¼
    *   `{tag}_step4_optimization_curve.png` â€“ ìµœì í™” ê³¡ì„  (Capture vs Purity)
    *   `{tag}_segmentation_overlay_roi.png` â€“ Cellpose vs Xenium ì„¸ê·¸ë©˜í…Œì´ì…˜ ë¹„êµ

#### ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­ (Technical Specs)

##### 2.1 Step 2: Segmentation-Free Analysis (ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ë¶„ì„)

**í•¨ìˆ˜**: `xb.calculating.dispersion()` (`xb/calculating.py` ë¼ì¸ 77-96)

**êµ¬í˜„ ì½”ë“œ**:
```python
def dispersion(reads_original, adata1):
    reads_assigned = reads_original  # ì „ì‚¬ì²´ ë°ì´í„°
    cells_metadata = adata1.obs  # ì„¸í¬ ë©”íƒ€ë°ì´í„° (x_centroid, y_centroid)

    # ì„¸í¬ ì¤‘ì‹¬ì (centroid) ì¢Œí‘œ ë§¤í•‘
    dictx = dict(zip(cells_metadata['cell_id'], cells_metadata['x_centroid']))
    dicty = dict(zip(cells_metadata['cell_id'], cells_metadata['y_centroid']))

    reads_assigned['x_cell'] = reads_assigned['cell_id'].map(dictx)
    reads_assigned['y_cell'] = reads_assigned['cell_id'].map(dicty)

    # Euclidean ê±°ë¦¬ ê³„ì‚°
    reads_assigned['distance'] = np.sqrt(
        ((reads_assigned['x_location'] - reads_assigned['x_cell'])**2) +
        ((reads_assigned['y_location'] - reads_assigned['y_cell'])**2)
    )
    return reads_assigned
```

**ì•Œê³ ë¦¬ì¦˜**: Euclidean Distance
$$d_{ij} = \sqrt{(x_{transcript,i} - x_{centroid,j})^2 + (y_{transcript,i} - y_{centroid,j})^2}$$

**ë°ì´í„° íë¦„**:
1. **ì…ë ¥**:
   - `reads_original`: ì „ì‚¬ì²´ ìœ„ì¹˜ (x_location, y_location, cell_id í¬í•¨)
   - `adata1`: AnnData ê°ì²´ (obsì— cell_id, x_centroid, y_centroid)
2. **ê³„ì‚°**: ê° ì „ì‚¬ì²´ì™€ í• ë‹¹ëœ ì„¸í¬ì˜ ì¤‘ì‹¬ì  ê°„ ê±°ë¦¬
3. **ì¶œë ¥**: `distance` ì»¬ëŸ¼ ì¶”ê°€ëœ DataFrame

**í•´ì„**:
- **ì‘ì€ ê±°ë¦¬** (< 5Âµm): ì „ì‚¬ì²´ê°€ ì„¸í¬ ì¤‘ì‹¬ ê·¼ì²˜ â†’ ì‹ ë¢°ì„± ë†’ìŒ
- **ì¤‘ê°„ ê±°ë¦¬** (5-10Âµm): ì„¸í¬ ê²½ê³„ ê·¼ì²˜
- **í° ê±°ë¦¬** (> 10Âµm): ì„¸í¬ ê°€ì¥ìë¦¬ ë˜ëŠ” ì ì¬ì  ì˜¤í• ë‹¹(misassignment)

**ì¶œë ¥ ë¶„ì„**:
- `step2_gene_distances.csv`: ê±°ë¦¬ í†µê³„ (mean, median, std, ë¶„ìœ„ìˆ˜)
- `step2_gene_dist_plot.png`: íˆìŠ¤í† ê·¸ë¨ (ë¶„í¬ í˜•íƒœ)
- `step2_gene_dist_boxplot.png`: ë°•ìŠ¤í”Œë¡¯ (ì´ìƒì¹˜ ê°ì§€)

##### 2.2 Step 2.3: Cell Overlap Analysis (Zì¶• ì‹ í˜¸ ì¼ê´€ì„±)

**í•¨ìˆ˜**: `step2_overlaps.run_step2_overlaps()` (`step2_overlaps.py` ë¼ì¸ 15-69)

**ëª©ì **: Zì¶• ë°©í–¥ ì „ì‚¬ì²´ ë¶„í¬ ë¶„ì„ (3D ì„¸ê·¸ë©˜í…Œì´ì…˜ ì¼ê´€ì„± í‰ê°€)

**êµ¬í˜„**:
```python
if 'z_location' in spots.columns:
    z_stats = spots.groupby('cell_id')['z_location'].agg(['min', 'max', 'std'])
    z_stats['z_range'] = z_stats['max'] - z_stats['min']
```

**í•´ì„**:
| ì§€í‘œ | ì˜ë¯¸ |
|:---|:---|
| **z_range** | ì„¸í¬ ë‚´ Zì¶• ë²”ìœ„. ì‘ì„ìˆ˜ë¡ ì‹ í˜¸ê°€ í•œ í‰ë©´ì— ì§‘ì¤‘ |
| **z_std** | Zì¶• í‘œì¤€í¸ì°¨. ì‘ì„ìˆ˜ë¡ ê· ì¼ ë¶„í¬ |

**í•´ì„ ì˜ˆ**:
- z_range â‰ˆ 0: ëª¨ë“  ì „ì‚¬ì²´ê°€ ê±°ì˜ ê°™ì€ Zë†’ì´ â†’ 2D ì ˆí¸ ë°ì´í„°
- z_range > 10: ì„¸í¬ê°€ ì—¬ëŸ¬ Zì¸µì— ê±¸ì³ ìˆìŒ â†’ 3D êµ¬ì¡° ì •ë³´ ë³´ì¡´

##### 2.3 Step 2.4: Segmentation-Free Analysis using SSAM (KDE)

**í•¨ìˆ˜**: `step2_ssam.run_step2_ssam()` (`step2_ssam.py` ë¼ì¸ 14-63)

**ëª©ì **: ì„¸ê·¸ë©˜í…Œì´ì…˜ ì •ë³´ ì—†ì´ Kernel Density Estimation(KDE)ìœ¼ë¡œ ì „ì‚¬ì²´ ê³µê°„ ë¶„í¬ íŒŒì•…

**êµ¬í˜„**:
```python
plt.hist2d(x, y, bins=200, cmap='viridis', cmin=1)
```

**í•´ì„**:
- ë°ì€ ì˜ì—­: ì „ì‚¬ì²´ ë°€ë„ ë†’ìŒ (ì„¸í¬ í’ë¶€ ì§€ì—­)
- ì–´ë‘ìš´ ì˜ì—­: ì „ì‚¬ì²´ ë°€ë„ ë‚®ìŒ (ì„¸í¬ì™¸ ê¸°ì§ˆ ë˜ëŠ” ëŒ€ì‚¬ ë¶€ìœ„)
- 2D íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ì¡°ì§ êµ¬ì¡° ì‹œê°í™”

**ì°¸ê³ **: `ssam` ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì—¬ë¶€ì— ë”°ë¼ ê°„ë‹¨í•œ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ ëŒ€ì²´

---

##### 2.4 Step 4: Optimal Expansion (ì„¸í¬ ê²½ê³„ ìµœì í™”)

**í•¨ìˆ˜**: `xb.simulating.allcombs()` ë˜ëŠ” `allcombs_simulated()` (`xb/simulating.py`)

**ê°œë…**: Xenium ì„¸ê·¸ë©˜í…Œì´ì…˜ ê²½ê³„ë¡œë¶€í„° ê³ ì • ê±°ë¦¬ë§Œí¼ í™•ì¥í–ˆì„ ë•Œ ìµœì  ê±°ë¦¬ ì°¾ê¸°

**ì‹œë®¬ë ˆì´ì…˜ íŒŒë¼ë¯¸í„°**:
| íŒŒë¼ë¯¸í„° | ë²”ìœ„ | ì„¤ëª… |
|:---|:---:|:---|
| **í™•ì¥ ê±°ë¦¬** ($d_{exp}$) | 0 ~ 15 Âµm | ì„¸í¬ ê²½ê³„ë¡œë¶€í„° ë°”ê¹¥ìª½ í™•ì¥ ê±°ë¦¬ |
| **ê°„ê²©** | 0.5 ë˜ëŠ” 1.0 Âµm | ì‹œë®¬ë ˆì´ì…˜ ìŠ¤í… í¬ê¸° |

**í‰ê°€ ì§€í‘œ (Metrics)**:

1. **Capture (í¬íšë¥ )**:
   $$\text{Capture}(d_{exp}) = \frac{N_{transcripts}(d \le d_{exp})}{N_{total}} \times 100\%$$
   - ì˜ë¯¸: í™•ì¥ ê±°ë¦¬ ë‚´ì— í¬í•¨ë˜ëŠ” ì „ì‚¬ì²´ì˜ ë¹„ìœ¨
   - ëª©í‘œ: ìµœëŒ€í™” (ëª¨ë“  ì§„ì •í•œ ì„¸í¬ ì „ì‚¬ì²´ í¬í•¨)

2. **Purity (ìˆœë„ - ëŒ€ìš© ì§€í‘œ)**:
   $$\text{Purity}(d_{exp}) = \frac{N_{nuclear\_overlap}}{N_{transcripts}(d \le d_{exp})}$$
   - ì˜ë¯¸: í¬í•¨ëœ ì „ì‚¬ì²´ ì¤‘ í•µ ì˜ì—­ê³¼ ê²¹ì¹˜ëŠ” ë¹„ìœ¨
   - ê°€ì •: í•µ ë‚´ë¶€ ì „ì‚¬ì²´ëŠ” 100% í•´ë‹¹ ì„¸í¬ì˜ ê²ƒ
   - ëª©í‘œ: ë†’ê²Œ ìœ ì§€ (ë‹¤ë¥¸ ì„¸í¬ ì „ì‚¬ì²´ ì˜¤í• ë‹¹ ìµœì†Œí™”)

**ìµœì ì  ì„ ì • (Elbow Method)**:
- Capture ê³¡ì„ : ì´ˆë°˜ì— ê¸‰ì¦ â†’ ì ì°¨ í¬í™”
- Purity ê³¡ì„ : ì´ˆë°˜ ë†’ìŒ â†’ ì ì°¨ ê°ì†Œ
- **ì„ ì •**: CaptureëŠ” ë†’ìœ¼ë©´ì„œ Purityê°€ ê¸‰ê²©íˆ ë–¨ì–´ì§€ê¸° ì§ì „ì˜ "êº¾ì´ëŠ” ì "

**ì‹œê°í™”** (`step4_optimization_curve.png`):
- Xì¶•: í™•ì¥ ê±°ë¦¬ (0~15 Âµm)
- Yì¶• ì¢Œì¸¡: Capture (%)
- Yì¶• ìš°ì¸¡: Purity (%)
- êµì ì´ ìµœì  ê±°ë¦¬

**ì¶œë ¥**:
- `step4_optimal_expansion.csv`: ê° ê±°ë¦¬ë³„ Capture, Purity ê°’
- `step4_optimization_curve.png`: ìµœì í™” ê³¡ì„ 

---

##### 2.5 Step 5: Segmentation Benchmark (Cellpose)

**í•¨ìˆ˜**: `step5_benchmark.run_step5_benchmark()` (`step5_benchmark.py` ë¼ì¸ 26-100)

**ëª©ì **: Xenium ìì²´ ì„¸ê·¸ë©˜í…Œì´ì…˜ê³¼ AI ê¸°ë°˜ ì„¸ê·¸ë©˜í…Œì´ì…˜(Cellpose) ë¹„êµ

**êµ¬í˜„**:
```python
from cellpose import models

model = models.Cellpose(gpu=True, model_type='nuclei')
masks, flows, styles, diams = model.eval(
    img,
    diameter=diameter,  # 30.0 Âµm (ê¸°ë³¸ê°’)
    channels=[0,0],
    flow_threshold=flow_threshold,  # 0.4
    cellprob_threshold=cellprob_threshold  # 0.0
)
```

**íŒŒë¼ë¯¸í„° ìƒì„¸**:

| íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|:---|:---:|:---|
| `model_type` | 'nuclei' | Cellpose í•µ ê°ì§€ ëª¨ë¸ |
| `diameter` | 30.0 | ì˜ˆìƒ í•µ ì§ê²½ (Âµm) |
| `flow_threshold` | 0.4 | ê´‘í•™ íë¦„(optical flow) ì‹ ë¢°ë„ ì„ê³„ê°’ |
| `cellprob_threshold` | 0.0 | ì„¸í¬ í™•ë¥  ì„ê³„ê°’ (0 = ëª¨ë‘ í¬í•¨) |

**ì…ë ¥/ì¶œë ¥**:
- **ì…ë ¥**: DAPI ì´ë¯¸ì§€ (í•µ í˜•ê´‘)
- **ì¶œë ¥**:
  - `masks`: ê° ì„¸í¬IDê°€ í• ë‹¹ëœ 2D ë°°ì—´
  - `flows`: ê´‘í•™ íë¦„ ì •ë³´
  - `diams`: ê°ì§€ëœ ê° ì„¸í¬ì˜ ì§ê²½

**ë¹„êµ ë©”íŠ¸ë¦­**:
- **ê°ì§€ëœ ì„¸í¬ ìˆ˜**: `n_cells_xenium` vs `n_cells_cellpose`
- **Overlap ë¹„ìœ¨**: ë‘ ì„¸ê·¸ë©˜í…Œì´ì…˜ ê°„ ê³µê°„ ê²¹ì¹¨ ì •ë„
- **ì‹œê°í™”**: `segmentation_overlay_roi.png` (ë‘ ê²½ê³„ë¥¼ ë‹¤ë¥¸ ìƒ‰ìœ¼ë¡œ í‘œì‹œ)

### 3. Preprocessing (ì‚¬ìš©ì Step 3)
*   **ë§¤í•‘ ë‹¨ê³„**: `Step 1` (í†µí•© ìˆ˜í–‰)
*   **ğŸ“‚ ìƒì„± íŒŒì¼ (Outputs)**
    *   `{tag}_step1_umap_plot.png`, `{tag}_step1_marker_genes_dotplot.png`

#### ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­ (Technical Specs)
1.  **Normalization**: `sc.pp.normalize_total(target_sum=100)`. ì¼ë°˜ì ì¸ 10,000 ëŒ€ì‹  ê³µê°„ ì „ì‚¬ì²´ì˜ ë‚®ì€ ì¹´ìš´íŠ¸ë¥¼ ê³ ë ¤í•˜ì—¬ **100**ì„ ì‚¬ìš© (Xenium ë²¤ì¹˜ë§ˆí‚¹ ë…¼ë¬¸ ê¶Œì¥).
2.  **Transformation**: `sc.pp.log1p` (Log(x+1) ë³€í™˜).
3.  **Scaling**: `False` (ê¸°ë³¸ê°’). ê³µê°„ ë°ì´í„° ë…¸ì´ì¦ˆ ì¦í­ ë°©ì§€ë¥¼ ìœ„í•´ ìŠ¤ì¼€ì¼ë§ì€ ìƒëµí•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì„.
4.  **Clustering**:
    *   **Graph**: `sc.pp.neighbors(n_neighbors=15, n_pcs=20)`
    *   **Algorithm**: **Leiden** (Resolution 1.4 ë“± ì¡°ì • ê°€ëŠ¥).

### 4. SVF Feature Selection (ì‚¬ìš©ì Step 4)
*   **ë§¤í•‘ ë‹¨ê³„**: `Step 8` (SVF)
*   **ğŸ“‚ ìƒì„± íŒŒì¼ (Outputs)**
    *   `{tag}_step8_svf_spatialde.csv` â€“ SpatialDE ë¶„ì„ ê²°ê³¼ (FSV, p-value ë“±)
    *   `step8_svf/top_svgs_spatial.png` â€“ ìƒìœ„ ê³µê°„ ë³€ì´ ìœ ì „ì ì‹œê°í™”
    *   `step8_svf/spatialde_results.csv` â€“ SVF ìˆœìœ„ í…Œì´ë¸”

#### ê¸°ìˆ  ì„¸ë¶€ì‚¬í•­ (Technical Specs)

##### 4.1 Step 8: SVF (Spatially Variable Genes) ì‹ë³„

**í•¨ìˆ˜**: `step8_svf.run_step8_svf()` (`step8_svf.py` ë¼ì¸ 10-76)

**ê°œë…**: "ê³µê°„ìƒ ê°€ê¹Œìš´ ì„¸í¬ë“¤ì´ ìœ ì‚¬í•œ ë°œí˜„ íŒ¨í„´ì„ ë³´ì´ëŠ” ìœ ì „ì"ë¥¼ ì‹ë³„

**êµ¬í˜„ íŒŒì´í”„ë¼ì¸**:

```python
# 1. ë°ì´í„° ì¤€ë¹„ (ì •ê·œí™”, ì¹´ìš´íŠ¸ í•„í„°ë§)
counts = adata.X  # ë°œí˜„ í–‰ë ¬ (ì„¸í¬ Ã— ìœ ì „ì)
coords = adata.obs[['x_centroid', 'y_centroid']]  # ê³µê°„ ì¢Œí‘œ

# 2. ì •ê·œí™” (NaiveDE)
norm_expr = NaiveDE.stabilize(counts.T).T  # ë¶„ì‚° ì•ˆì •í™”

# 3. ê³µë³€ëŸ‰ ì œê±° (ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬ê¸° íšŒê·€)
resid_expr = NaiveDE.regress_out(coords, norm_expr.T, 'np.log(total_counts)').T

# 4. SpatialDE ì‹¤í–‰
results = SpatialDE.run(coords[['x', 'y']], resid_expr)

# 5. SVF ì„ ë³„ (p-value < 0.05)
svfs = results[results.qval < 0.05]
```

**ì•Œê³ ë¦¬ì¦˜**: SpatialDE (ê³µê°„ ìê¸°ìƒê´€)

**ì›ë¦¬**:
- **ê°€ì„¤**: "ê³µê°„ìƒ ì¸ì ‘í•œ ì„¸í¬ë“¤ì˜ ë°œí˜„ì´ ìœ ì‚¬í•œê°€?"
- **ê²€ì •**: ê° ìœ ì „ìì— ëŒ€í•´ Moran's I ë˜ëŠ” ìœ ì‚¬ í†µê³„ëŸ‰ ê³„ì‚°
- **ìŠ¤ì½”ì–´**:
  - **FSV (Fraction of Spatial Variance)**: ê³µê°„ íŒ¨í„´ì´ ì„¤ëª…í•˜ëŠ” ë¶„ì‚°ì˜ ë¹„ìœ¨ (0~1)
  - **p-value**: ê³µê°„ íŒ¨í„´ì´ ìš°ì—°ì˜ ì¼ì¹˜ê°€ ì•„ë‹ í™•ë¥ 

**íŒŒë¼ë¯¸í„°**:

| íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|:---|:---:|:---|
| **p-value ì„ê³„ê°’** | 0.05 | FDR ë³´ì •ëœ p-value < 0.05ì¸ ìœ ì „ì ì„ ë³„ |
| **ìµœì†Œ ìœ ì „ì ì¹´ìš´íŠ¸** | 10 | ì €ë°œí˜„ ìœ ì „ì í•„í„°ë§ |

**ë°ì´í„° ì „ì²˜ë¦¬** (`step8_svf.py` ë¼ì¸ 36-41):
```python
gene_counts = np.array(X_df.sum(axis=0)).flatten()
mask = gene_counts > 10  # ì¹´ìš´íŠ¸ < 10 ìœ ì „ì ì œê±°
X_df = X_df[:, mask]
```

**ì´ìœ **: ê·¹ë„ë¡œ ì €ë°œí˜„ëœ ìœ ì „ìëŠ”:
- í†µê³„ì  ì‹ ë¢°ë„ ë‚®ìŒ
- SVD ìˆ˜ë ´ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥
- ìƒë¬¼í•™ì  ì‹ í˜¸ ì•½í•¨

**ì¶œë ¥ í•´ì„**:

CSV íŒŒì¼ ì»¬ëŸ¼:
| ì»¬ëŸ¼ | ì˜ë¯¸ | ë²”ìœ„ | í•´ì„ |
|:---|:---|:---:|:---|
| `gene` | ìœ ì „ìëª… | - | - |
| `FSV` | ê³µê°„ ë¶„ì‚° ë¶„ìœ¨ | 0-1 | í´ìˆ˜ë¡ ê°•í•œ ê³µê°„ íŒ¨í„´ |
| `pval` | p-value | 0-1 | ì‘ì„ìˆ˜ë¡ ìœ ì˜í•¨ |
| `qval` | FDR ë³´ì • p-value | 0-1 | < 0.05 = SVF ì¸ì • |
| `g` | Moran's I | -1~1 | 1 = ê°•í•œ í´ëŸ¬ìŠ¤í„°ë§ |

**ì˜ˆì‹œ í•´ì„**:
```
gene      FSV     pval    qval    g
ERBB2     0.45    1e-20   1e-20   0.82  â† SVF (ê°•í•œ ê³µê°„ íŒ¨í„´)
HER2      0.42    1e-18   1e-18   0.78  â† SVF
GAPDH     0.02    0.45    0.78    0.05  â† ì•„ë‹˜ (ë¬´ì˜ë¯¸í•œ ê³µê°„ íŒ¨í„´)
```

**ì‹œê°í™”**:
- `top_svgs_spatial.png`: ìƒìœ„ SVF 5-10ê°œë¥¼ ê³µê°„ì—ì„œ ìƒ‰ì¹ í•œ ë§µ
  - ê°™ì€ ìƒ‰ê¹” ì„¸í¬ë“¤ì´ ì¸ì ‘ â†’ SVF í™•ì¸
  - ë¬´ì‘ìœ„ ë¶„í¬ â†’ SVF ì•„ë‹˜

---

---

## ğŸ“Š Output íŒŒì¼ ë¶„ì„ ê°€ì´ë“œ

íŒŒì´í”„ë¼ì¸ì´ ìƒì„±í•˜ëŠ” ëª¨ë“  íŒŒì¼ì„ ë‹¨ê³„ë³„ë¡œ í•´ì„í•˜ê³  í™œìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

### Output ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
output/
â”œâ”€â”€ {sample_tag}/
â”‚   â”œâ”€â”€ {tag}_step1_preprocessed.h5ad          # Step 1: ì „ì²˜ë¦¬ ì™„ë£Œ AnnData
â”‚   â”œâ”€â”€ {tag}_step1_qc_violin.png              # Step 1: QC ë°”ì´ì˜¬ë¦° í”Œë¡¯
â”‚   â”œâ”€â”€ {tag}_step1_pca_plot.png               # Step 1: PCA ì‚°ì ë„
â”‚   â”œâ”€â”€ {tag}_step1_pca_variance.png           # Step 1: PCA ë¶„ì‚° ì„¤ëª…ë ¥
â”‚   â”œâ”€â”€ {tag}_step1_umap_plot.png              # Step 1: UMAP í´ëŸ¬ìŠ¤í„°ë§
â”‚   â”œâ”€â”€ {tag}_step1_marker_genes_dotplot.png   # Step 1: ë§ˆì»¤ ìœ ì „ì dot plot
â”‚   â”œâ”€â”€ {tag}_step1_marker_genes.csv           # Step 1: ë§ˆì»¤ ìœ ì „ì í…Œì´ë¸”
â”‚   â”œâ”€â”€ {tag}_step2_gene_distances.csv         # Step 2: ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬
â”‚   â”œâ”€â”€ {tag}_step2_gene_dist_plot.png         # Step 2: ê±°ë¦¬ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨
â”‚   â”œâ”€â”€ {tag}_step2_gene_dist_boxplot.png      # Step 2: ê±°ë¦¬ ë¶„í¬ ë°•ìŠ¤í”Œë¡¯
â”‚   â”œâ”€â”€ {tag}_step2_reads_sample.parquet       # Step 2: ì „ì‚¬ì²´ ìƒ˜í”Œ
â”‚   â”œâ”€â”€ step2_overlaps/
â”‚   â”‚   â”œâ”€â”€ z_range_distribution.png           # Step 2.3: Zì¶• ë²”ìœ„ ë¶„í¬
â”‚   â”‚   â””â”€â”€ cell_z_stats.csv                   # Step 2.3: Zì¶• í†µê³„
â”‚   â”œâ”€â”€ step2_ssam/
â”‚   â”‚   â””â”€â”€ transcript_density_map.png         # Step 2.4: ë°€ë„ ë§µ
â”‚   â”œâ”€â”€ {tag}_step4_optimal_expansion.csv      # Step 4: ìµœì  ê±°ë¦¬ ê²°ê³¼
â”‚   â”œâ”€â”€ {tag}_step4_optimization_curve.png     # Step 4: ìµœì í™” ê³¡ì„ 
â”‚   â”œâ”€â”€ {tag}_segmentation_overlay_roi.png     # Step 5: ì„¸ê·¸ë©˜í…Œì´ì…˜ ë¹„êµ
â”‚   â”œâ”€â”€ {tag}_step6_summary.csv                # Step 6: í´ëŸ¬ìŠ¤í„° í†µê³„
â”‚   â”œâ”€â”€ {tag}_step6_silhouette_scores.csv      # Step 6: Silhouette ìŠ¤ì½”ì–´
â”‚   â”œâ”€â”€ {tag}_step6_ari_scores.csv             # Step 6: ARI ìŠ¤ì½”ì–´
â”‚   â”œâ”€â”€ {tag}_comparison_gt_vs_pipeline.png    # Step 7: ê¸°ì¤€ ë°ì´í„° ë¹„êµ
â”‚   â””â”€â”€ step8_svf/
â”‚       â”œâ”€â”€ top_svgs_spatial.png               # Step 8: SVF ê³µê°„ ì‹œê°í™”
â”‚       â””â”€â”€ spatialde_results.csv              # Step 8: SVF ìƒì„¸ ê²°ê³¼
```

---

### Step 1: ë°ì´í„° ë¡œë”© & QC ë¶„ì„

#### ğŸ“„ `{tag}_step1_qc_violin.png` í•´ì„

**ê·¸ë˜í”„ êµ¬ì„±**:
```
Yì¶• (ê°’ì˜ í¬ê¸°)
     â”‚
 500 â”‚  â•±â•²         â•±â•²         â•±â•²
     â”‚ â•±  â•²       â•±  â•²       â•±  â•²
 300 â”‚â•±    â•²â”€â”€â”€â”€â”€â•±    â•²â”€â”€â”€â”€â”€â•±    â•²
     â”‚      â•²         â•²         â•²
 100 â”‚       â•²         â•²         â•²
   0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     n_counts    n_genes    ê¸°íƒ€ì§€í‘œ
     (Xì¶•)
```

**ë°”ì´ì˜¬ë¦° í”Œë¡¯ ì½ê¸°**:
- **Xì¶•**: 3ê°œ ë°”ì´ì˜¬ë¦° (ê°ê° n_counts, n_genes, ê¸°íƒ€ ë©”íŠ¸ë¦­)
- **Yì¶•**: ê°’ì˜ ë²”ìœ„
- **ë„“ì´**: í•´ë‹¹ ê°’ì„ ê°€ì§„ ì„¸í¬ì˜ ê°œìˆ˜ (ë„“ì„ìˆ˜ë¡ ë§ìŒ)
- **ê°€ìš´ë° ì **: ì¤‘ì•™ê°’ (median)
- **ê°€ìš´ë° ì„ **: ì‚¬ë¶„ìœ„ìˆ˜ ë²”ìœ„ (IQR)

**ì¢‹ì€ ì‹ í˜¸ (ì •ìƒ ë°ì´í„°)**:
```
âœ“ n_counts ë°”ì´ì˜¬ë¦°:
  - ì¤‘ê°„ê°’ 50-500 ë²”ìœ„
  - ëŒ€ì¹­ì ì¸ ì¢… ëª¨ì–‘
  - ê·¹ë‹¨ê°’ ì ìŒ

âœ“ n_genes ë°”ì´ì˜¬ë¦°:
  - ì¤‘ê°„ê°’ 20-100 ë²”ìœ„
  - ìš°ì¸¡ ê¸´ ê¼¬ë¦¬ ì—†ìŒ
  - ê³ ë¥´ê²Œ ë¶„í¬

ì˜ˆì‹œ:
    â”‚ â•±â•²       â•±â•²
    â”‚â•±  â•²     â•±  â•²
    â•±    â•²â”€â”€â”€â•±    â•²
```

**ì£¼ì˜ ì‹ í˜¸ (ë¬¸ì œ ë°ì´í„°)**:

1. **n_counts ë„ˆë¬´ ë‚®ìŒ** (< 10):
```
    â”‚ â”‚  â† ê·¹ë„ë¡œ ì¢ìŒ
    â”‚ â”‚
    â”‚â–¯â”‚  â† ì €í’ˆì§ˆ ì„¸í¬ ë§ìŒ
â†’ í•´ê²°ì±…: ë” ì—„ê²©í•œ í•„í„°ë§, ë˜ëŠ” ë°ì´í„° ê²€í† 
```

2. **n_genes ê·¹ë„ë¡œ ë¶ˆê· í˜•** (ì´ìƒì¹˜ ë§ìŒ):
```
    â”‚ â•±â•²
    â”‚â•±  â•²___________
    â”‚                â•²  â•²  â•²  â† ê·¹ë‹¨ê°’ ë§ìŒ
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë˜ëŠ” debris ë§ìŒ
â†’ í•´ê²°ì±…: Cellpose/Baysorë¡œ ì¬ë¶„ì„
```

3. **n_counts ìš°ì¸¡ ê¼¬ë¦¬** (ë†’ì€ ê°’ì˜ ì„¸í¬ ë§ìŒ):
```
    â”‚  â•±â•²
    â”‚ â•±  â•²___________  â•² â•²
â†’ ë‹¤ì¤‘ ì„¸í¬ í¬í•¨ ê°€ëŠ¥ì„±
â†’ í•´ê²°ì±…: ë” ë†’ì€ min_counts ì„¤ì •
```

**ì •ëŸ‰ì  ë¶„ì„** (ì½”ë“œ):
```python
import matplotlib.pyplot as plt
import numpy as np

# QC ë©”íŠ¸ë¦­ í™•ì¸
adata = sc.read('sample_step1_preprocessed.h5ad')
print(f"Median counts: {adata.obs['n_counts'].median()}")
print(f"Median genes: {adata.obs['n_genes'].median()}")
print(f"IQR counts: {adata.obs['n_counts'].quantile(0.75) - adata.obs['n_counts'].quantile(0.25)}")

# ì´ìƒì¹˜ í™•ì¸
outliers_counts = adata.obs[adata.obs['n_counts'] > 1000]
outliers_genes = adata.obs[adata.obs['n_genes'] > 300]
print(f"Cells with >1000 counts: {len(outliers_counts)} ({len(outliers_counts)/len(adata)*100:.1f}%)")
```

---

### Step 3: ì „ì²˜ë¦¬ & ì°¨ì› ì¶•ì†Œ ë¶„ì„

#### ğŸ“Š `{tag}_step1_pca_plot.png` í•´ì„ (PCA ì‚°ì ë„)

**ê·¸ë˜í”„ êµ¬ì„±**:
```
PC2 (ì œ2 ì£¼ì„±ë¶„)
  â”‚
50â”‚        â—â—â—â—â—â—     â† í´ëŸ¬ìŠ¤í„° B
  â”‚       â—â—â—  â—â—
  â”‚      â—â—     â—â—
  0â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€ PC1 (ì œ1 ì£¼ì„±ë¶„)
  â”‚          â—â—â—â—â—â—
 -50â”‚           â—â—â—â—â—     â† í´ëŸ¬ìŠ¤í„° A
  â”‚            â—
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
 -50   0   50   100

ìƒ‰ìƒ: í´ëŸ¬ìŠ¤í„°ë³„ë¡œ ë‹¤ë¥¸ ìƒ‰ í‘œì‹œ
í¬ê¸°: ëª¨ë‘ ë™ì¼ (ë˜ëŠ” ì„¸í¬ ë©”íƒ€ë°ì´í„°ë¡œ í‘œí˜„)
```

**ì¢‹ì€ ì‹ í˜¸ (í´ëŸ¬ìŠ¤í„°ê°€ ëª…í™•)**:
```
âœ“ ë™ì¼ ìƒ‰ìƒ ì„¸í¬ë“¤ì´ í•¨ê»˜ ë­‰ì³ìˆìŒ (Cluster A, B, C ë¶„ë¦¬)
âœ“ í´ëŸ¬ìŠ¤í„° ê°„ ê²¹ì¹¨ ìµœì†Œí™”
âœ“ 3ê°œ ì´ìƒì˜ ëª…í™•í•œ í´ëŸ¬ìŠ¤í„° í˜•ì„±

ì˜ˆ:
    B B B
  B B B B B
      A A A A
    A A A A A
          C C C
        C C C C C

â†’ "ìƒë¬¼í•™ì ìœ¼ë¡œ ë‹¤ì–‘í•œ ì„¸í¬ íƒ€ì… ì¡´ì¬"
```

**ë¬¸ì œ ì‹ í˜¸ (í´ëŸ¬ìŠ¤í„° ë¶ˆëª…í™•)**:

1. **ëª¨ë“  ì ì´ í•œ ë©ì–´ë¦¬**:
```
    â—â—â—â—â—â—â—â—â—â—
    â—â—â—â—â—â—â—â—â—
    â—â—â—â—â—â—â—â—â—
â†’ ìƒë¬¼í•™ì  ë‹¤ì–‘ì„± ë¶€ì¡± ë˜ëŠ” ë°°ì¹˜ íš¨ê³¼ (Batch effect)
â†’ ì›ì¸: ë‹¨ìˆœ ì¡°ì§, ë˜ëŠ” ì „ì²˜ë¦¬ ì˜¤ë¥˜
â†’ í•´ê²°ì±…: ë°°ì¹˜ ë³´ì • (sc.pp.combat ë“±) ê²€í† 
```

2. **ì„ í˜• ë¶„ë¦¬ (ì¼ì§ì„ )**:
```
  â—\
   â—\
    â—\
     â—\
      â—\
       â—
â†’ í•œ ë°©í–¥ì˜ ë³€í™”ë§Œ ì¡´ì¬ (ì ì§„ì  ë¶„í™” ë“±)
â†’ ìƒë¬¼í•™ì ìœ¼ë¡œ íƒ€ë‹¹í•œ ê²½ìš°ë„ ìˆìŒ (ë¶„í™” ê¶¤ì )
```

3. **ê·¹ë‹¨ê°’(Outlier) ë§ìŒ**:
```
  â—  â—    â—
â—            â—
    â—â—â—
    â—â—â—  â—
          â—
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë˜ëŠ” debris
â†’ í•´ê²°ì±…: QC í•„í„° ë” ì—„ê²©í•˜ê²Œ
```

**ì •ëŸ‰ì  ë¶„ì„** (ì½”ë“œ):
```python
import scanpy as sc
import pandas as pd

adata = sc.read('sample_step1_preprocessed.h5ad')

# í´ëŸ¬ìŠ¤í„°ë³„ ì„¸í¬ ê°œìˆ˜
cluster_counts = adata.obs['leiden_1_4'].value_counts().sort_index()
print("í´ëŸ¬ìŠ¤í„°ë³„ ì„¸í¬ ê°œìˆ˜:")
print(cluster_counts)

# í´ëŸ¬ìŠ¤í„° ìˆ˜
n_clusters = adata.obs['leiden_1_4'].nunique()
print(f"\nì´ í´ëŸ¬ìŠ¤í„° ìˆ˜: {n_clusters}")

# í´ëŸ¬ìŠ¤í„°ë³„ ë¹„ìœ¨
print("\ní´ëŸ¬ìŠ¤í„° ë¹„ìœ¨:")
print((cluster_counts / len(adata) * 100).round(1))

# íŒì •
if n_clusters >= 3:
    print("âœ“ í´ëŸ¬ìŠ¤í„°ë§ ì„±ê³µ")
elif n_clusters == 1:
    print("âŒ í´ëŸ¬ìŠ¤í„° ë¶€ì¡± (ìƒë¬¼í•™ì  ì´ì§ˆì„± ì—†ìŒ)")
else:
    print("âš ï¸ í´ëŸ¬ìŠ¤í„° ìˆ˜ ì ìŒ (ì£¼ì˜ í•„ìš”)")
```

---

#### ğŸ“ˆ `{tag}_step1_pca_variance.png` í•´ì„ (ë¶„ì‚° ì„¤ëª…ë ¥)

**ê·¸ë˜í”„ êµ¬ì„±**:
```
ëˆ„ì  ë¶„ì‚° ì„¤ëª…ë ¥ (%)
    â”‚
100%â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚                 â–²
 80%â”‚          â•±â•±â•±â•±â•±â•±â•±
    â”‚        â•±â•±â•±â•±
 60%â”‚      â•±â•±â•±
    â”‚    â•±â•±
 40%â”‚  â•±â•±
    â”‚â•±â•±
  0%â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
    0   10   20   30   40
    PC (Principal Component ë²ˆí˜¸)

ì„ : ëˆ„ì  ë¶„ì‚° (Cumulative Variance)
â¬¤â¬¤â¬¤: ê° PCì˜ ê°œë³„ ë¶„ì‚° (optional)
```

**ë¶„ì‚° ì„¤ëª…ë ¥ì˜ ì˜ë¯¸**:
- PC1ì´ ì„¤ëª…í•˜ëŠ” ë¶„ì‚°: ì²« ë²ˆì§¸ë¡œ ì¤‘ìš”í•œ ë³€ìˆ˜
- PC1+PC2: ì²˜ìŒ ë‘ ë³€ìˆ˜ê°€ ì„¤ëª…í•˜ëŠ” ë¶„ì‚°
- ëˆ„ì  ë¶„ì‚°: PC1ë¶€í„° PCnê¹Œì§€ ëª¨ë‘ í¬í•¨í–ˆì„ ë•Œ

**ì¢‹ì€ ì‹ í˜¸**:

1. **ê¸‰ê²©í•œ ìƒìŠ¹** (ì´ˆë°˜ì— ë¹ ë¥´ê²Œ ì˜¬ë¼ê°):
```
100%â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚      â•±â•±â•±â•±  â† ê°€íŒŒë¥¸ ìƒìŠ¹
 80%â”‚   â•±â•±â•±â•±â•±
    â”‚ â•±â•±
  0%â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
   0  5  10  20

í•´ì„: ì²˜ìŒ 5-10ê°œ PCê°€ ëŒ€ë¶€ë¶„ì˜ ì •ë³´ ì„¤ëª…
â†’ "ë°ì´í„° êµ¬ì¡°ê°€ ë‹¨ìˆœí•˜ê³  ëª…í™•"
â†’ ë…¸ì´ì¦ˆ ì ìŒ, ì‹ í˜¸ ê°•í•¨
```

2. **PC20ì—ì„œ 80% ì´ìƒ**:
```
ëˆ„ì  ë¶„ì‚° 80% ë„ë‹¬ ì‹œì  < 20
â†’ ì¢‹ì€ ë°ì´í„° í’ˆì§ˆ
â†’ í´ëŸ¬ìŠ¤í„°ë§ ì‹ ë¢°ì„± ë†’ìŒ
```

**ë¬¸ì œ ì‹ í˜¸**:

1. **ì™„ë§Œí•œ ìƒìŠ¹** (ì²œì²œíˆ ì˜¬ë¼ê°):
```
100%â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚    â•±â•±â•±â•±â•±â•±â•±â•±â•±â•±  â† ì™„ë§Œí•œ ìƒìŠ¹
    â”‚  â•±â•±â•±â•±
  0%â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
   0  10  20  30  40

í•´ì„: PC40 ì´ìƒì´ì–´ì•¼ 80% ë„ë‹¬
â†’ "ê³ ì°¨ì› ë°ì´í„°, ë…¸ì´ì¦ˆ ë§ìŒ"
â†’ ì‹ í˜¸:ë…¸ì´ì¦ˆ ë¹„ìœ¨ ë‚®ìŒ
```

2. **PC50ì—ì„œ ì•„ì§ 80% ë¯¸ë§Œ**:
```
â†’ ê·¹ë„ë¡œ ë§ì€ ë…¸ì´ì¦ˆ ë˜ëŠ” ë³µì¡í•œ êµ¬ì¡°
â†’ í•´ê²°ì±…: ë‹¤ì‹œ ì „ì²˜ë¦¬ ê²€í† 
```

**ë¶„ì„ ì½”ë“œ**:
```python
import scanpy as sc
import numpy as np

adata = sc.read('sample_step1_preprocessed.h5ad')

# PCA ë¶„ì‚° ì¶”ì¶œ
pca_var = adata.uns['pca']['variance']
cumsum = np.cumsum(pca_var) / np.sum(pca_var)

# 80% ë„ë‹¬ ì‹œì 
pc_80 = np.argmax(cumsum >= 0.8) + 1
print(f"80% ë¶„ì‚° ì„¤ëª…: PC {pc_80}")

# ê° PCë³„ ë¶„ì‚°
for i in range(5):
    print(f"PC{i+1}: {cumsum[i]:.1%} (ê°œë³„: {pca_var[i]/np.sum(pca_var):.1%})")

# íŒì •
if pc_80 <= 20:
    print("âœ“ ìš°ìˆ˜í•œ ë°ì´í„° (PC20 ì´ë‚´ 80% ë„ë‹¬)")
elif pc_80 <= 50:
    print("âš ï¸ ì–‘í˜¸í•œ ë°ì´í„° (ì•½ê°„ì˜ ë…¸ì´ì¦ˆ)")
else:
    print("âŒ ë…¸ì´ì¦ˆ ë§ìŒ (ì¬ë¶„ì„ ê¶Œê³ )")
```

---

#### ğŸ“ `{tag}_step1_umap_plot.png` í•´ì„ (UMAP í´ëŸ¬ìŠ¤í„°ë§)

**ê·¸ë˜í”„ êµ¬ì„±**:
```
UMAP 2
  â”‚
10â”‚  ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥      â† í´ëŸ¬ìŠ¤í„° 0 (ë¹¨ê°•)
  â”‚  ğŸŸ¥ğŸŸ¥ ğŸŸ¥
  â”‚    ğŸŸ¨ğŸŸ¨ğŸŸ¨     â† í´ëŸ¬ìŠ¤í„° 1 (ë…¸ë‘)
 5â”‚   ğŸŸ¨ğŸŸ¨ ğŸŸ©
  â”‚    ğŸŸ©ğŸŸ©ğŸŸ©     â† í´ëŸ¬ìŠ¤í„° 2 (ì´ˆë¡)
  â”‚    ğŸŸ©ğŸŸ©
  â”‚     ğŸŸ¦      â† í´ëŸ¬ìŠ¤í„° 3 (íŒŒë‘)
 0â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ UMAP 1
   0   5   10   15

ìƒ‰ìƒ: leiden_1_4 í´ëŸ¬ìŠ¤í„° ID
í¬ê¸°: ëª¨ë‘ ë™ì¼
```

**ì¢‹ì€ ì‹ í˜¸ (í´ëŸ¬ìŠ¤í„° ë¶„ë¦¬ ëª…í™•)**:
```
âœ“ ê° ìƒ‰ìƒ ì„¸í¬ë“¤ì´ ë­‰ì³ìˆìŒ
âœ“ ìƒ‰ìƒ ê°„ ëª…í™•í•œ ê²½ê³„
âœ“ 3ê°œ ì´ìƒ ìƒ‰ìƒ ì¡´ì¬
âœ“ ìƒ‰ìƒ ë‚´ ì¼ê´€ì„± ë†’ìŒ

ì˜ˆ:
ğŸŸ¥ğŸŸ¥ğŸŸ¥    ğŸŸ¨ğŸŸ¨ğŸŸ¨    ğŸŸ©ğŸŸ©ğŸŸ©
ğŸŸ¥ğŸŸ¥ğŸŸ¥    ğŸŸ¨ğŸŸ¨ğŸŸ¨    ğŸŸ©ğŸŸ©ğŸŸ©
  (Cluster 0)  (Cluster 1)  (Cluster 2)
```

**ë¬¸ì œ ì‹ í˜¸**:

1. **ìƒ‰ìƒì´ ì„ì—¬ìˆìŒ (ë¶„ë¦¬ ì•ˆ ë¨)**:
```
ğŸŸ¥ğŸŸ¨ğŸŸ©ğŸŸ¥ğŸŸ¨ğŸŸ©
ğŸŸ¨ğŸŸ¥ğŸŸ©ğŸŸ¨ğŸŸ¥ğŸŸ©
ğŸŸ©ğŸŸ¨ğŸŸ¥ğŸŸ©ğŸŸ¨ğŸŸ¥
â†’ í´ëŸ¬ìŠ¤í„° ê²½ê³„ê°€ ë¶ˆëª…í™•
â†’ ìƒë¬¼í•™ì ìœ¼ë¡œ ìœ ì‚¬í•œ ì„¸í¬ë“¤
â†’ í•´ê²°ì±…: í•´ìƒë„ ì¡°ì • ë˜ëŠ” ì¶”ê°€ ë§ˆì»¤ ê²€í† 
```

2. **ìƒ‰ìƒë³„ë¡œ ë–¨ì–´ì ¸ìˆìŒ (ê·¹ë‹¨ê°’)**:
```
ğŸŸ¥            ğŸŸ¨
  â—â—â—  â—â—â—
ğŸŸ©            ğŸŸ¦
â†’ ê·¹ë‹¨ ì„¸í¬ë“¤ì´ ë¶„ë¦¬ë¨ (outlier)
â†’ í•´ê²°ì±…: QC í•„í„° ê²€í† 
```

**PCA vs UMAPì˜ ì°¨ì´**:
```
PCA í”Œë¡¯:          UMAP í”Œë¡¯:
- ì„ í˜• ì¶•ì†Œ         - ë¹„ì„ í˜• ì¶•ì†Œ
- ì›ë³¸ ë¶„ì‚° ë³´ì¡´   - ì§€ì—­ êµ¬ì¡° ê°•ì¡°
- í•´ì„ ì‰¬ì›€        - ì‹œê°ì ìœ¼ë¡œ ë¶„ë¦¬ ì˜ë¨
- ìˆ˜í•™ì  ëª…í™•      - ê±°ë¦¬ í•´ì„ ì£¼ì˜

â†’ PCA: ë°ì´í„° êµ¬ì¡° ì´í•´
â†’ UMAP: í´ëŸ¬ìŠ¤í„° ë¶„ë¦¬ í™•ì¸
```

#### ğŸ” `{tag}_step1_marker_genes_dotplot.png` í•´ì„ (ë§ˆì»¤ ìœ ì „ì Dot Plot)

**ê·¸ë˜í”„ êµ¬ì„±**:
```
Marker Genes (Yì¶•)
â”‚
â”‚ SOX2       ğŸ”µ      âšª     âšª       â† íŒŒë€ìƒ‰(ë°œí˜„), í°ìƒ‰(ë¯¸ë°œí˜„)
â”‚ TUBB3      âšª     ğŸ”µ      âšª
â”‚ GFAP       âšª      âšª     ğŸ”µ
â”‚ NESTIN     ğŸ”µ     ğŸ”µ      âšª
â”‚ CD34       âšª      âšª     ğŸ”µ
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Cluster (Xì¶•)
   Cluster 0 Cluster 1 Cluster 2

ì ì˜ í¬ê¸°: ë°œí˜„ ì„¸í¬ ë¹„ìœ¨ (ë„“ì„ìˆ˜ë¡ ë§ì´ ë°œí˜„)
ì ì˜ ìƒ‰ìƒ: í‰ê·  ë°œí˜„ ìˆ˜ì¤€ (íŒŒë‘ì´ ì§™ì„ìˆ˜ë¡ ë†’ìŒ)
```

**Dot plot ì½ê¸°**:
- **Xì¶•**: í´ëŸ¬ìŠ¤í„° ID (0, 1, 2, ...)
- **Yì¶•**: ë§ˆì»¤ ìœ ì „ìëª… (ìƒë¬¼í•™ì ìœ¼ë¡œ ì¤‘ìš”í•œ ìœ ì „ìë“¤)
- **ì ì˜ í¬ê¸°**: pct_expressed (0-100%) - í•´ë‹¹ ìœ ì „ìë¥¼ ë°œí˜„í•œ ì„¸í¬ì˜ ë¹„ìœ¨
  - ì‘ì€ ì : < 30% ì„¸í¬ë§Œ ë°œí˜„
  - ì¤‘ê°„ ì : 30-70% ì„¸í¬ ë°œí˜„
  - í° ì : > 70% ì„¸í¬ ë°œí˜„
- **ì ì˜ ìƒ‰ìƒ**: mean_expression - í‰ê·  ë°œí˜„ ìˆ˜ì¤€
  - í°ìƒ‰/ì—°í•œìƒ‰: ë°œí˜„ ë¯¸ì•½
  - ì§™ì€ íŒŒë‘ìƒ‰: ê°•í•œ ë°œí˜„

**ì¢‹ì€ ì‹ í˜¸ (í´ëŸ¬ìŠ¤í„° íŠ¹ì´ì  ë§ˆì»¤)**:
```
âœ“ ê° í´ëŸ¬ìŠ¤í„°ë§ˆë‹¤ í¬ê³  íŒŒë€ ì ì´ ë‹¤ë¥¸ ìœ„ì¹˜ì— ìˆìŒ
âœ“ ê°™ì€ ìœ ì „ìê°€ ë‹¤ë¥¸ í´ëŸ¬ìŠ¤í„°ì—ì„  ì‘ê±°ë‚˜ ì—°í•¨

ì˜ˆ:
SOX2      ğŸ”µ       âšª       âšª     â† Cluster 0ì—ì„œ ê°•í•¨
TUBB3     âšª      ğŸ”µ       âšª     â† Cluster 1ì—ì„œ ê°•í•¨
GFAP      âšª       âšª      ğŸ”µ     â† Cluster 2ì—ì„œ ê°•í•¨

â†’ "í´ëŸ¬ìŠ¤í„°ë“¤ì´ ìƒë¬¼í•™ì ìœ¼ë¡œ ëª…í™•íˆ ë‹¤ë¦„"
â†’ "ê° í´ëŸ¬ìŠ¤í„°ë³„ ì„¸í¬ íƒ€ì… ì •ì˜ ê°€ëŠ¥"
```

**ë¬¸ì œ ì‹ í˜¸**:

1. **ëª¨ë“  ì ì´ ë¹„ìŠ·í•œ í¬ê¸°/ìƒ‰ìƒ**:
```
SOX2      ğŸ”µ      ğŸ”µ      ğŸ”µ
TUBB3     ğŸ”µ      ğŸ”µ      ğŸ”µ
GFAP      ğŸ”µ      ğŸ”µ      ğŸ”µ

â†’ ëª¨ë“  í´ëŸ¬ìŠ¤í„°ì—ì„œ ëª¨ë“  ìœ ì „ì ë°œí˜„
â†’ í´ëŸ¬ìŠ¤í„°ë“¤ì´ ìƒë¬¼í•™ì ìœ¼ë¡œ ìœ ì‚¬
â†’ ì›ì¸: ë‹¨ìˆœ ì¡°ì§, ì§ˆë³‘ ìƒíƒœ, ë˜ëŠ” ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜
â†’ í•´ê²°ì±…: ì¶”ê°€ ë¶„ì„ í•„ìš” (ê³µê°„ ì •ë³´ í™œìš© ë“±)
```

2. **íŠ¹ì • ìœ ì „ìë§Œ ë°œí˜„** (ë‹¤ë¥¸ ìœ ì „ìëŠ” ëª¨ë‘ ë¯¸ë°œí˜„):
```
SOX2      ğŸ”µ      ğŸ”µ      ğŸ”µ
TUBB3     âšª      âšª      âšª
GFAP      âšª      âšª      âšª

â†’ ë§ˆì»¤ ìœ ì „ì ë¶€ì¡± (ìœ ì „ì íŒ¨ë„ ë¶ˆì™„ì „)
â†’ í•´ê²°ì±…: ë” ë§ì€ ë§ˆì»¤ ìœ ì „ì ì¶”ê°€
```

3. **í´ëŸ¬ìŠ¤í„°ë³„ ë§ˆì»¤ ì—†ìŒ** (íŠ¹ì • í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ì ì´ ì‘ìŒ):
```
SOX2      ğŸ”µ      âšª      ğŸ”µ
TUBB3     ğŸ”µ      âšª      ğŸ”µ
GFAP      ğŸ”µ      âšª      ğŸ”µ

â†’ Cluster 1ì˜ ê³ ìœ  ë§ˆì»¤ ë¶€ì¡±
â†’ ì´ í´ëŸ¬ìŠ¤í„°ì˜ ì •ì²´ì„± ë¶ˆë¶„ëª…
â†’ í•´ê²°ì±…: í•´ìƒë„ ì¡°ì • (ë³‘í•©) ë˜ëŠ” ì¶”ê°€ ë§ˆì»¤ ê²€í† 
```

**ì •ëŸ‰ì  ë¶„ì„** (ì½”ë“œ):
```python
import pandas as pd

markers = pd.read_csv('{tag}_step1_marker_genes.csv')

# í´ëŸ¬ìŠ¤í„°ë³„ ë§ˆì»¤ ìœ ì „ì ê°œìˆ˜ (pct_expressed > 50%, mean_expression > 1)
for cluster in markers['cluster'].unique():
    cluster_markers = markers[
        (markers['cluster'] == cluster) &
        (markers['pct_expressed'] > 50) &
        (markers['mean_expression'] > 1)
    ]
    print(f"Cluster {cluster}: {len(cluster_markers)} marker genes")
    print(f"  Top 3: {cluster_markers.nlargest(3, 'mean_expression')['gene'].tolist()}")

# ê° ìœ ì „ìì˜ íŠ¹ì´ì„± (specificity)
# í•œ í´ëŸ¬ìŠ¤í„°ì—ì„œë§Œ ë°œí˜„ë˜ëŠ” ì •ë„
specificity = {}
for gene in markers['gene'].unique():
    gene_data = markers[markers['gene'] == gene]
    # ë°œí˜„í•œ í´ëŸ¬ìŠ¤í„° ê°œìˆ˜
    clusters_expressed = (gene_data['pct_expressed'] > 30).sum()
    specificity[gene] = clusters_expressed

# ë†’ì€ íŠ¹ì´ì„± ìœ ì „ì (1ê°œ í´ëŸ¬ìŠ¤í„°ì—ì„œë§Œ ë°œí˜„)
specific_genes = [g for g, c in specificity.items() if c == 1]
print(f"\níŠ¹ì´ì  ë§ˆì»¤ ìœ ì „ì ({len(specific_genes)}ê°œ):")
print(specific_genes[:10])
```

---

#### ğŸ¨ `{tag}_marker_genes_violin.png` í•´ì„ (ë§ˆì»¤ ìœ ì „ì ë°”ì´ì˜¬ë¦°)

**ê·¸ë˜í”„ êµ¬ì„±**:
```
ë°œí˜„ê°’
   â”‚
 3 â”‚  â•±â•²           â•±â•²           â•±â•²
   â”‚ â•±  â•²         â•±  â•²         â•±  â•²
 2 â”‚â•±    â•²â”€â”€â”€â”€â”€â”€â”€â•±    â•²â”€â”€â”€â”€â”€â”€â”€â•±    â•²
   â”‚      â•²             â•²             â•²
 1 â”‚       â•²             â•²             â•²
   â”‚        â•²             â•²             â•²
 0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SOX2        TUBB3          GFAP
   C0 C1 C2   C0 C1 C2      C0 C1 C2

ê° ìœ ì „ìë³„ ë°”ì´ì˜¬ë¦° (3ê°œ = 3ê°œ í´ëŸ¬ìŠ¤í„°)
```

**í•´ì„**:
- **ë†’ì€ ë°”ì´ì˜¬ë¦°**: í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì—ì„œ ê°•í•œ ë°œí˜„
- **ë‚®ì€ ë°”ì´ì˜¬ë¦°**: ì•½í•œ ë°œí˜„ ë˜ëŠ” ë¯¸ë°œí˜„
- **ì¤‘ì•™ê°’**: í•´ë‹¹ í´ëŸ¬ìŠ¤í„°ì˜ í‰ê·  ë°œí˜„

**ì¢‹ì€ ì‹ í˜¸**:
```
âœ“ ê° ìœ ì „ìë§ˆë‹¤ íŠ¹ì • í´ëŸ¬ìŠ¤í„°ì—ì„œë§Œ ë†’ì€ ë°”ì´ì˜¬ë¦°
âœ“ ìœ ì „ì ê°„ ë°œí˜„ íŒ¨í„´ ì„œë¡œ ë‹¤ë¦„
â†’ "ê° ìœ ì „ìê°€ íŠ¹ì • ì„¸í¬ íƒ€ì…ì„ í‘œì‹œ"
```

**ë¬¸ì œ ì‹ í˜¸**:
```
âœ— ëª¨ë“  ë°”ì´ì˜¬ë¦°ì´ ë¹„ìŠ·í•œ ë†’ì´
â†’ í´ëŸ¬ìŠ¤í„° íŠ¹ì´ì„± ë‚®ìŒ
```

---

### Step 2: ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ë¶„ì„

#### ğŸ“ˆ `{tag}_step2_gene_dist_plot.png` (íˆìŠ¤í† ê·¸ë¨) í•´ì„

**ë¶„í¬ í˜•íƒœ**:

**ì´ìƒì ì¸ ë¶„í¬**:
```
      â”‚
      â”‚     â•±â•²
      â”‚    â•±  â•²
      â”‚   â•±    â•²____
      â”‚  â•±          â•²___
    0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ê±°ë¦¬ (Âµm)
        2   4   6   8  10  12

í•´ì„: ëŒ€ë¶€ë¶„ ì „ì‚¬ì²´ê°€ 0-5Âµm ë²”ìœ„
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì •í™•ë„ ë†’ìŒ
```

**ë¬¸ì œ ìƒí™© - ì™¼ìª½ í¸í–¥**:
```
      â”‚     â•±â•±â•±â•±â•±â•±â•±â•±
      â”‚    â•±
      â”‚   â•±
      â”‚  â•±
    0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ê±°ë¦¬ (Âµm)

í•´ì„: ê±°ì˜ ëª¨ë“  ì „ì‚¬ì²´ < 3Âµm
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ ê²½ê³„ê°€ ë„ˆë¬´ ì¢ìŒ (ì„¸í¬ í¬ê¸° ì‘ìŒ ì„¤ì •?)
```

**ë¬¸ì œ ìƒí™© - ì˜¤ë¥¸ìª½ ê¼¬ë¦¬**:
```
      â”‚  â•±\
      â”‚ â•±  \
      â”‚â•±    \___________â•²â•²â•²â•²
      â”‚                    â•²â•²â•²
    0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ê±°ë¦¬ (Âµm)

í•´ì„: ë©€ë¦¬ ë–¨ì–´ì§„ ì „ì‚¬ì²´ ë§ìŒ (> 10Âµm)
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ë˜ëŠ” ì„¸í¬ í¬ê¸° ê³¼ëŒ€í‰ê°€
```

**ì •ëŸ‰ì  ë¶„ì„** (CSV íŒŒì¼ í™œìš©):
```python
import pandas as pd

dist_df = pd.read_csv('{tag}_step2_gene_distances.csv')

# í†µê³„
print(f"ì¤‘ì•™ê°’: {dist_df['distance'].median():.2f} Âµm")
print(f"í‰ê· : {dist_df['distance'].mean():.2f} Âµm")
print(f"í‘œì¤€í¸ì°¨: {dist_df['distance'].std():.2f} Âµm")

# ë°±ë¶„ìœ„ìˆ˜
print(f"25th percentile: {dist_df['distance'].quantile(0.25):.2f} Âµm")
print(f"75th percentile: {dist_df['distance'].quantile(0.75):.2f} Âµm")
print(f"95th percentile: {dist_df['distance'].quantile(0.95):.2f} Âµm")

# ë¬¸ì œ ì „ì‚¬ì²´ ì‹ë³„ (ê±°ë¦¬ > 15 Âµm)
outliers = dist_df[dist_df['distance'] > 15]
print(f"ê±°ë¦¬ > 15 Âµm: {len(outliers)} ({len(outliers)/len(dist_df)*100:.1f}%)")
```

**í•´ì„ ê¸°ì¤€**:
| ì¤‘ì•™ê°’ | í‰ê°€ | ì¡°ì¹˜ |
|:---|:---:|:---|
| < 3 Âµm | ì¢‹ìŒ | Step 4ë¡œ ì§„í–‰ |
| 3-7 Âµm | ì–‘í˜¸ | Step 4ë¡œ ì§„í–‰, ê²°ê³¼ ì£¼ì˜ |
| > 7 Âµm | ì£¼ì˜ | ì„¸ê·¸ë©˜í…Œì´ì…˜ ì¬í‰ê°€ í•„ìš” |

#### ğŸ“Š `step2_overlaps/z_range_distribution.png` í•´ì„

**Zì¶• ë²”ìœ„ ë¶„í¬ì˜ ì˜ë¯¸**:

**ì¢‹ì€ ì‹ í˜¸** (Z-range â‰ˆ 0):
```
ëŒ€ë¶€ë¶„ì˜ ì„¸í¬ê°€ Z-range = 0-2 Âµm
â†’ ë°ì´í„°ê°€ ì •í™•íˆ ê°™ì€ Z ë†’ì´ì—ì„œ ìˆ˜ì§‘
â†’ 2D ì ˆí¸ Xenium ì‹¤í—˜
```

**ì ë‹¹í•œ ì‹ í˜¸** (Z-range = 2-10 Âµm):
```
ì„¸í¬ë§ˆë‹¤ ë‹¤ì–‘í•œ Z ë¶„í¬
â†’ 3D ì´ë¯¸ì§•, ì„¸í¬ê°€ ì—¬ëŸ¬ Zì¸µì— ê±¸ì¹¨
â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ì´ Zì¶•ë„ í¬í•¨ (3D ëª¨ë¸)
```

**ì£¼ì˜ ì‹ í˜¸** (Z-range > 10 Âµm):
```
ì„¸í¬ ë‚´ Z ë¶„í¬ê°€ ë§¤ìš° í¼
â†’ 3D ì¡°ì§ ìŠ¬ë¼ì´ìŠ¤ì—ì„œ ì—¬ëŸ¬ ì„¸í¬ì¸µ ìˆ˜ì§‘
â†’ ë¶„ì„ ì‹œ Zì¶• ë³´ì • í•„ìš” ê°€ëŠ¥

í•´ê²°ì±…: Zì¶• ì •ê·œí™” ë˜ëŠ” Zì¸µë³„ ë¶„ì„
```

#### ğŸ’¾ `step2_ssam/transcript_density_map.png` í•´ì„

**ë°€ë„ ë§µ ë¶„ì„**:

**ì¢‹ì€ ì‹ í˜¸**:
```
ë°ì€ ì˜ì—­(ë†’ì€ ë°€ë„)ì´ íŠ¹ì • êµ¬ì¡°ë¥¼ ë”°ë¦„
ì˜ˆ) ì‹ ê²½ í”¼ì§ˆ: 6ì¸µ êµ¬ì¡° ë³´ì´ëŠ” ëŒ€ì—­ íŒ¨í„´
    ìœ ë°©ì•”: ì¢…ì–‘ ì˜ì—­ ì£¼ë³€ ë†’ì€ ë°€ë„
â†’ ì¡°ì§ êµ¬ì¡°ê°€ ëª…í™•í•¨
```

**ë¬¸ì œ ì‹ í˜¸**:
```
1. ê· ì¼í•œ ë¶„í¬ (gradient ì—†ìŒ)
   â†’ ì¡°ì§ êµ¬ì¡° ë¶ˆëª…í™• ë˜ëŠ” í˜¼í•©ëœ ì„¸í¬ íƒ€ì…

2. ëœë¤í•œ í•«ìŠ¤íŒŸ
   â†’ ê¸°ìˆ ì  artifact ë˜ëŠ” debris ì¶•ì 
```

---

### Step 4: ìµœì  í™•ì¥ ê±°ë¦¬ ë¶„ì„

#### ğŸ“ˆ `{tag}_step4_optimization_curve.png` í•´ì„ (ìµœì í™” ê³¡ì„ )

**ê·¸ë˜í”„ êµ¬ì„±**:
```
ì´ì¤‘ Yì¶• ê·¸ë˜í”„:
Capture (%)          â”‚                    Purity (%)
 (ì¢Œì¸¡ Yì¶•)          â”‚                  (ìš°ì¸¡ Yì¶•)
      100 â”‚          â”‚                100
          â”‚    â•±â•±â•±â•±â•±â•±â•±  â† Capture   â”‚ â•²â•²â•²â•² â† Purity
       80 â”‚  â•±â•±â•±                    â”‚   â•²â•²â•²â•²
          â”‚â•±â•±                       â”‚      â•²â•²â•²
       0  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜0      â•²â•²
          0    5    10    15     â”‚
          í™•ì¥ê±°ë¦¬ (Âµm)          â”‚
                            ìµœì ì  Ã—
                          (ì˜ˆ: 6Âµm)
```

**ê³¡ì„ ì˜ ì˜ë¯¸**:

1. **Capture ê³¡ì„ ** (ìƒìŠ¹í•˜ëŠ” ì„ ):
```
0Âµm â†’ 15Âµmìœ¼ë¡œ ê°ˆìˆ˜ë¡ ìƒìŠ¹
â†’ "ì„¸í¬ ê²½ê³„ë¥¼ ë” ë„“íˆë©´ ë” ë§ì€ ì „ì‚¬ì²´ í¬í•¨"

ì˜ˆì‹œ:
ê±°ë¦¬ 0Âµm: 20% (í•µ ì˜ì—­ë§Œ, ë§¤ìš° ë³´ìˆ˜ì )
ê±°ë¦¬ 5Âµm: 80% (ëŒ€ë¶€ë¶„ í¬í•¨)
ê±°ë¦¬ 10Âµm: 95% (ê±°ì˜ ëª¨ë‘ í¬í•¨)
ê±°ë¦¬ 15Âµm: 99% (ê±°ì˜ 100%)
```

2. **Purity ê³¡ì„ ** (í•˜ê°•í•˜ëŠ” ì„ ):
```
0Âµm â†’ 15Âµmìœ¼ë¡œ ê°ˆìˆ˜ë¡ í•˜ê°•
â†’ "ì„¸í¬ ê²½ê³„ë¥¼ ë” ë„“íˆë©´ ë‹¤ë¥¸ ì„¸í¬ ì „ì‚¬ì²´ë„ í¬í•¨"

ì˜ˆì‹œ:
ê±°ë¦¬ 0Âµm: 100% (ìˆœí•µ ì˜ì—­ë§Œ, 100% ìˆœë„)
ê±°ë¦¬ 5Âµm: 85% (ì•½ 15% ì˜¤í• ë‹¹)
ê±°ë¦¬ 10Âµm: 70% (ì•½ 30% ì˜¤í• ë‹¹)
ê±°ë¦¬ 15Âµm: 50% (ì ˆë°˜ì€ ì¸ì ‘ ì„¸í¬ì˜ ê²ƒ)
```

**ì¢‹ì€ ì‹ í˜¸ (ê· í˜•ì¡íŒ ê³¡ì„ )**:
```
Capture         Purity
  â”‚ â•±â•±â•±â•±         â”‚â•²â•²â•²â•²
  â”‚â•±â•±â•±â•±â•±â•±â•±       â”‚  â•²â•²â•²â•²
  â”‚â•±â•±â•±           â”‚    â•²â•²
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ë‘ ê³¡ì„ ì´ ì¶©ë¶„íˆ ë©€ë¦¬ ë–¨ì–´ì ¸ ìˆìŒ
â†’ Capture 80% ë„ë‹¬ ì‹œì ê³¼ Purity 70% ìœ ì§€ ì‹œì ì´ ë¹„ìŠ·í•¨
â†’ ëª…í™•í•œ ìµœì ì  ì¡´ì¬
```

**ë¬¸ì œ ì‹ í˜¸**:

1. **Captureê°€ ë„ˆë¬´ ì²œì²œíˆ ìƒìŠ¹**:
```
  â”‚        â•±â•±â•±â•±  â† ë„ˆë¬´ ëŠë¦° ìƒìŠ¹
  â”‚     â•±â•±â•±â•±
  â”‚   â•±â•±
  â”‚ â•±â•±
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0  5  10  15

â†’ ê±°ë¦¬ë¥¼ ë§ì´ ëŠ˜ë ¤ì•¼ ì¶©ë¶„í•œ í¬íš
â†’ ì›ì¸: ì„¸ê·¸ë©˜í…Œì´ì…˜ì´ ë„ˆë¬´ ì‘ê±°ë‚˜ ê±°ë¦¬ ê³„ì‚° ì˜¤ë¥˜
â†’ í•´ê²°ì±…: ì„¸ê·¸ë©˜í…Œì´ì…˜ ì¬ê²€í† 
```

2. **Purityê°€ ë„ˆë¬´ ë¹ ë¥´ê²Œ í•˜ê°•**:
```
  â”‚â•²â•²â•²â•²â•²â•²â•²â•²â•²  â† ê¸‰ê²©í•œ í•˜ê°•
  â”‚  â•²â•²â•²â•²â•²
  â”‚    â•²â•²â•²
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0  5  10  15

â†’ ì•½ê°„ë§Œ í™•ì¥í•´ë„ ë‹¤ë¥¸ ì„¸í¬ í¬í•¨
â†’ ì›ì¸: ì„¸í¬ë“¤ì´ ë§¤ìš° ì‘ê±°ë‚˜ ê²¹ì¹¨
â†’ í•´ê²°ì±…: ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜ ê°€ëŠ¥ì„± ë†’ìŒ
```

3. **êµì  ì—†ìŒ** (ë™ì‹œ ë§Œì¡± ë¶ˆê°€):
```
Capture                Purity
  â”‚ â•±â•±â•±â•±â•±â•±â•±           â”‚ â•²â•²â•²â•²â•²â•²â•²
80% ë ˆë²¨ì— ë„ë‹¬ ë¶ˆê°€   â”‚ 70% ë ˆë²¨ ì´ìƒ ë¶ˆê°€
  â”‚ â•±â•±â•±â•±              â”‚    â•²â•²â•²â•²â•²
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  0  5  10  15        0  5  10  15

â†’ Captureì™€ Purityë¥¼ ë™ì‹œì— ë§Œì¡±í•˜ëŠ” ê±°ë¦¬ ë¶€ì¬
â†’ íŠ¸ë ˆì´ë“œì˜¤í”„ ì„ íƒ í•„ìš”
```

**ìµœì ì  ì„ ì • ê¸°ì¤€**:

| ê¸°ì¤€ | ì„¤ëª… | ìš°ì„ ìˆœìœ„ |
|:---|:---|:---:|
| **Capture â‰¥ 80%** | ì¶©ë¶„í•œ ì „ì‚¬ì²´ í¬íš | ë†’ìŒ |
| **Purity â‰¥ 70%** | ì˜¤í• ë‹¹ ìµœì†Œí™” | ë†’ìŒ |
| **Elbow** | ê³¡ì„ ì˜ "êº¾ì´ëŠ” ì " | ì¤‘ê°„ |
| **ì—°ì†ì„±** | ì¸ì ‘ ê±°ë¦¬ì™€ì˜ ê¸‰ê²©í•œ ë³€í™” ì—†ìŒ | ë‚®ìŒ |

**ì„ íƒ ì „ëµ**:

```python
import pandas as pd

opt_df = pd.read_csv('{tag}_step4_optimal_expansion.csv')

# ì „ëµ 1: ì—„ê²©í•œ ê¸°ì¤€ (ë‘˜ ë‹¤ ë§Œì¡±)
optimal_strict = opt_df[
    (opt_df['Capture'] >= 80) &
    (opt_df['Purity'] >= 70)
]
if len(optimal_strict) > 0:
    optimal_dist = optimal_strict.iloc[0]['expansion_distance']
    print(f"âœ“ ìµœì  ê±°ë¦¬ (ì—„ê²©): {optimal_dist} Âµm")
else:
    print("âš ï¸ ë™ì‹œ ë§Œì¡± ë¶ˆê°€")

# ì „ëµ 2: Capture ìš°ì„  (ëœ ì—„ê²©)
# ì´ìœ : ë¯¸í¬í•¨ëœ ì „ì‚¬ì²´ëŠ” ë³µêµ¬ ë¶ˆê°€, ì˜¤í• ë‹¹ì€ í†µê³„ë¡œ ë³´ì • ê°€ëŠ¥
optimal_capture = opt_df[opt_df['Capture'] >= 85]
if len(optimal_capture) > 0:
    optimal_dist = optimal_capture.iloc[0]['expansion_distance']
    print(f"ğŸ”„ ìµœì  ê±°ë¦¬ (Capture ìš°ì„ ): {optimal_dist} Âµm")

# ì „ëµ 3: Purity ìš°ì„  (ë” ì—„ê²©)
# ì´ìœ : ì •í™•ë„ê°€ ìµœìš°ì„ ì¸ ê²½ìš°
optimal_purity = opt_df[opt_df['Purity'] >= 75]
if len(optimal_purity) > 0:
    optimal_dist = optimal_purity.iloc[-1]['expansion_distance']  # ë§ˆì§€ë§‰ (ê°€ì¥ í¬ê¸°ë§Œ í•¨)
    print(f"ğŸ¯ ìµœì  ê±°ë¦¬ (Purity ìš°ì„ ): {optimal_dist} Âµm")
```

**í•´ì„ ì˜ˆì‹œ**:

```
ìƒí™© 1: ì¢…ì–‘ ë¶„ì„ (ì•” ìœ ì „ì ë°œí˜„ ì •í™•ë„ ì¤‘ìš”)
â†’ Purity ìš°ì„ : 6 Âµm (Purity 85%)
â†’ "ì •í™•í•œ ì˜¤í• ë‹¹ ìµœì†Œí™”"

ìƒí™© 2: ì„¸í¬ íƒ€ì… ë¶„ë¥˜ (ìƒë¬¼í•™ì  ë‹¤ì–‘ì„± ì¤‘ìš”)
â†’ Capture ìš°ì„ : 8 Âµm (Capture 90%)
â†’ "ëª¨ë“  ì„¸í¬ í¬í•¨í•˜ë˜ ì•½ê°„ì˜ ì˜¤í• ë‹¹ í—ˆìš©"

ìƒí™© 3: ì¼ë°˜ì  ë¶„ì„
â†’ ê· í˜• ì„ íƒ: 7 Âµm (Capture 85%, Purity 75%)
â†’ "ì–‘ìª½ ë‹¤ í•©ë¦¬ì "
```

**ë¶„ì„ ì½”ë“œ**:
```python
import pandas as pd
import matplotlib.pyplot as plt

opt_df = pd.read_csv('{tag}_step4_optimal_expansion.csv')

# ìµœì ì  ì°¾ê¸°
# ì¡°ê±´: Capture > 80% AND Purity > 70%
optimal = opt_df[(opt_df['Capture'] >= 80) & (opt_df['Purity'] >= 70)]
if len(optimal) > 0:
    optimal_distance = optimal.iloc[0]['expansion_distance']
    print(f"ê¶Œì¥ í™•ì¥ ê±°ë¦¬: {optimal_distance} Âµm")
else:
    print("âš ï¸ ë™ì‹œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê±°ë¦¬ ì—†ìŒ")
    print("â†’ Capture vs Purity íŠ¸ë ˆì´ë“œì˜¤í”„ í•„ìš”")
```

#### ğŸ’¾ `{tag}_step4_optimal_expansion.csv` í™œìš©

**CSV ì»¬ëŸ¼**:
```
expansion_distance,Capture,Purity,n_transcripts_included
0.0,45.2,98.5,125430
0.5,52.1,98.1,145670
1.0,58.3,97.2,165890
...
15.0,92.1,62.3,425680
```

**ë¶„ì„**:
1. **Capture ì¦ê°€**: ì„¸í¬ ê²½ê³„ í™•ì¥ìœ¼ë¡œ ë” ë§ì€ ì „ì‚¬ì²´ í¬í•¨
2. **Purity ê°ì†Œ**: í™•ì¥ì´ ê³¼í•˜ë©´ ì¸ì ‘ ì„¸í¬ ì „ì‚¬ì²´ë„ í¬í•¨
3. **íŠ¸ë ˆì´ë“œì˜¤í”„**: ìƒë¬¼í•™ì  ì§ˆë¬¸ì— ë§ì¶° ì„ íƒ
   - ë³´ìˆ˜ì  ë¶„ì„ â†’ ë†’ì€ Purity (& ë‚®ì€ Capture)
   - í¬ê´„ì  ë¶„ì„ â†’ ë†’ì€ Capture (& ë‚®ì€ Purity)

---

### Step 5: ì„¸ê·¸ë©˜í…Œì´ì…˜ ë²¤ì¹˜ë§ˆí¬

#### ğŸ“¸ `{tag}_segmentation_overlay_roi.png` í•´ì„

**ì˜¤ë²„ë ˆì´ ë§µ**:
```
ìƒ‰ìƒ í•´ì„:
- ë¹¨ê°•: Xenium ì„¸ê·¸ë©˜í…Œì´ì…˜ë§Œ (CellposeëŠ” ë¯¸ê°ì§€)
- íŒŒë‘: Cellposeë§Œ ê°ì§€ (Xeniumì€ ë¯¸ê°ì§€)
- ë³´ë¼: ë‘ ë°©ë²• ëª¨ë‘ ê°ì§€ (ê²¹ì¹¨ ì˜ì—­)
- ê²€ì •: ì„¸í¬ ì—†ìŒ

ì¢‹ì€ ì‹ í˜¸: ë³´ë¼ìƒ‰(ê²¹ì¹¨) ë§ìŒ, ë¹¨ê°•/íŒŒë‘ ì ìŒ
ë¬¸ì œ ì‹ í˜¸: ë¹¨ê°•/íŒŒë‘ ë§ìŒ â†’ ë°©ë²• ê°„ í° ì°¨ì´
```

**ì •ëŸ‰ ë¶„ì„**:
```python
# ê°ì§€ëœ ì„¸í¬ ìˆ˜ ë¹„êµ
n_xenium = len(xenium_segmentation)
n_cellpose = len(cellpose_segmentation)
overlap = calculate_overlap(xenium, cellpose)

overlap_ratio = overlap / max(n_xenium, n_cellpose)
print(f"Xenium ê°ì§€ ì„¸í¬: {n_xenium}")
print(f"Cellpose ê°ì§€ ì„¸í¬: {n_cellpose}")
print(f"Overlap ë¹„ìœ¨: {overlap_ratio:.2%}")

# í•´ì„
if overlap_ratio > 0.85:
    print("âœ“ ìš°ìˆ˜í•œ ì¼ì¹˜ë„ (ì‹ ë¢°ì„± ë†’ìŒ)")
elif overlap_ratio > 0.70:
    print("âš ï¸ ì–‘í˜¸í•œ ì¼ì¹˜ë„ (ì£¼ì˜ ë¶„ì„)")
else:
    print("âŒ ë‚®ì€ ì¼ì¹˜ë„ (ì¬ê²€í†  í•„ìš”)")
```

---

### Step 8: ê³µê°„ ë³€ì´ ìœ ì „ì (SVF) ë¶„ì„

#### ğŸ“Š `{tag}_step8_svf_spatialde.csv` í•´ì„

**ê²°ê³¼ í•´ì„**:

```python
import pandas as pd

svf_df = pd.read_csv('{tag}_step8_svf_spatialde.csv')
svf_df_filtered = svf_df[svf_df['qval'] < 0.05].sort_values('FSV', ascending=False)

# ìƒìœ„ 10ê°œ SVF í™•ì¸
print("ìƒìœ„ 10ê°œ ê³µê°„ ë³€ì´ ìœ ì „ì:")
print(svf_df_filtered[['gene', 'FSV', 'pval', 'qval', 'g']].head(10))

# ì˜ˆìƒ ê²°ê³¼
"""
       gene     FSV      pval      qval      g
0     ERBB2    0.45    1.2e-20  5.3e-21  0.82
1      HER2    0.42    3.4e-18  7.2e-19  0.78
2     GATA3    0.38    8.9e-16  1.1e-16  0.75
3      MUC1    0.35    2.1e-14  2.2e-15  0.71
4     PIP4K2A 0.32    5.6e-13  5.5e-14  0.68
...
"""
```

**ì»¬ëŸ¼ë³„ í•´ì„**:

| ì»¬ëŸ¼ | ë²”ìœ„ | í•´ì„ | í™œìš© |
|:---|:---:|:---|:---|
| **FSV** | 0-1 | ê³µê°„ ë¶„ì‚° ë¹„ìœ¨. í´ìˆ˜ë¡ ê°•í•œ ê³µê°„ íŒ¨í„´ | ìš°ì„ ìˆœìœ„ ìˆœìœ„ ê²°ì • |
| **pval** | 0-1 | í†µê³„ ìœ ì˜ì„± (ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ) | í•„í„°ë§ ë¯¸ì‚¬ìš© (qval ì‚¬ìš©) |
| **qval** | 0-1 | FDR ë³´ì • p-value. **< 0.05 = SVF** | ì£¼ìš” í•„í„° ì¡°ê±´ |
| **g** | -1~1 | Moran's I. 1 = ì™„ë²½ í´ëŸ¬ìŠ¤í„°ë§ | ê³µê°„ íŒ¨í„´ ê°•ë„ ì¸¡ì • |

**ìƒë¬¼í•™ì  í•´ì„**:

```python
# ìƒìœ„ SVFë“¤ì˜ ê¸°ëŠ¥ ë¶„ì„
top_svfs = svf_df_filtered['gene'].head(20).tolist()

# 1. ì¡°ì§ íŠ¹ì´ì„± í™•ì¸
print("ìƒìœ„ SVF ìœ ì „ìë“¤ì˜ ìƒë¬¼í•™ì  íŠ¹ì„±:")
for gene in top_svfs[:5]:
    row = svf_df[svf_df['gene'] == gene].iloc[0]
    print(f"{gene}: FSV={row['FSV']:.2f}, g={row['g']:.2f}")
    # ìœ ì „ì ê¸°ëŠ¥ ê²€ìƒ‰ (ë³„ë„ DB í•„ìš”)

# 2. ì¡°ì§ êµ¬ì¡° ë§¤í•‘
# FSV > 0.3ì¸ ìœ ì „ìë“¤ â†’ ì¡°ì§ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ” í•µì‹¬ ìœ ì „ì
# ì´ë“¤ì˜ ë°œí˜„ íŒ¨í„´ìœ¼ë¡œ ì¡°ì§ ë„ë©”ì¸ ì •ì˜ ê°€ëŠ¥
```

**ì‹¤ì œ ì˜ˆì‹œ (ìœ ë°©ì•”)**:
```
ERBB2, HER2, GATA3 ë“± ë†’ì€ FSV
â†’ ì¢…ì–‘ ê·¸ë£¹ë‚´ ì¼ê´€ë˜ê²Œ ë†’ì€ ë°œí˜„
â†’ ì¢…ì–‘ í‘œì§€ìë¡œ í™œìš© ê°€ëŠ¥

FOXC1 ë‚®ì€ FSV
â†’ ì¢…ì–‘ê³¼ ì •ìƒ ì¡°ì§ ëª¨ë‘ ë°œí˜„
â†’ ì¡°ì§ êµ¬ì¡° êµ¬ë¶„ì— ë„ì›€ ì•ˆ ë¨
```

---

## ğŸ”— Output í™œìš© ì›Œí¬í”Œë¡œìš°

### 1ï¸âƒ£ ë°ì´í„° í’ˆì§ˆ ê²€ì¦ (Step 1)

```python
import scanpy as sc
import pandas as pd

# Step 1 ê²°ê³¼ ë¡œë“œ
adata = sc.read('sample_step1_preprocessed.h5ad')

# QC ë©”íŠ¸ë¦­ í™•ì¸
print(f"ì„¸í¬ ìˆ˜: {adata.n_obs}")
print(f"ìœ ì „ì ìˆ˜: {adata.n_vars}")
print(f"í´ëŸ¬ìŠ¤í„° ìˆ˜: {adata.obs['leiden_1_4'].nunique()}")

# ë¬¸ì œì  ì§„ë‹¨
if adata.n_obs < 100:
    print("âš ï¸ ì„¸í¬ ìˆ˜ ë¶€ì¡± (< 100)")
if adata.obs['leiden_1_4'].nunique() < 3:
    print("âš ï¸ í´ëŸ¬ìŠ¤í„° ë¶€ì¡± (ìƒë¬¼í•™ì  ì´ì§ˆì„± ë‚®ìŒ)")
```

### 2ï¸âƒ£ ì„¸ê·¸ë©˜í…Œì´ì…˜ ì •í™•ë„ í‰ê°€ (Step 2, 4, 5)

```python
# Step 2 ê±°ë¦¬ ë¶„ì„
dist_df = pd.read_csv('sample_step2_gene_distances.csv')
median_dist = dist_df['distance'].median()

if median_dist < 3:
    seg_quality = "ìš°ìˆ˜"
elif median_dist < 7:
    seg_quality = "ì–‘í˜¸"
else:
    seg_quality = "ì¬ê²€í†  í•„ìš”"

# Step 4 ìµœì  ê±°ë¦¬ ê²°ì •
opt_df = pd.read_csv('sample_step4_optimal_expansion.csv')
optimal = opt_df[(opt_df['Capture'] >= 80) & (opt_df['Purity'] >= 70)]
recommended_distance = optimal.iloc[0]['expansion_distance'] if len(optimal) > 0 else "ì—†ìŒ"

print(f"ì„¸ê·¸ë©˜í…Œì´ì…˜ í’ˆì§ˆ: {seg_quality}")
print(f"ê¶Œì¥ í™•ì¥ ê±°ë¦¬: {recommended_distance} Âµm")
```

### 3ï¸âƒ£ ìƒë¬¼í•™ì  ë§ˆì»¤ ì‹ë³„ (Step 1, 8)

```python
# Step 1 ë§ˆì»¤ ìœ ì „ì
markers = pd.read_csv('sample_step1_marker_genes.csv')
cluster_0_markers = markers[markers['cluster'] == 0].head(5)

# Step 8 ê³µê°„ ë³€ì´ ìœ ì „ì
svf = pd.read_csv('sample_step8_svf_spatialde.csv')
svf_filtered = svf[svf['qval'] < 0.05].sort_values('FSV', ascending=False)

# êµì§‘í•©: í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ì´ë©´ì„œ ë™ì‹œì— ê³µê°„ì ìœ¼ë¡œ ë³€ì´í•˜ëŠ” ìœ ì „ì
cluster_markers = set(cluster_0_markers['gene'])
spatial_markers = set(svf_filtered['gene'])
key_markers = cluster_markers & spatial_markers

print(f"í•µì‹¬ ë§ˆì»¤ ìœ ì „ì: {key_markers}")
# ì´ë“¤ì€ ì¡°ì§ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ìœ ì „ì
```

---

## âœ… ë¶„ì„ ê²°ê³¼ í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

ìµœì¢… ê²°ê³¼ë¥¼ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€í•˜ê¸° ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸:

- [ ] **QC í†µê³¼**: ì„¸í¬ < 10 ì¹´ìš´íŠ¸ ì œê±°ë¨
- [ ] **í´ëŸ¬ìŠ¤í„°ë§ ì„±ê³µ**: 3ê°œ ì´ìƒ í´ëŸ¬ìŠ¤í„° í˜•ì„±
- [ ] **ë§ˆì»¤ ìœ ì „ì**: ê° í´ëŸ¬ìŠ¤í„°ë³„ ê³ ìœ  ë§ˆì»¤ > 5ê°œ
- [ ] **ì„¸ê·¸ë©˜í…Œì´ì…˜**: ì¤‘ì•™ê°’ ê±°ë¦¬ < 7 Âµm
- [ ] **ìµœì  í™•ì¥**: Capture â‰¥ 80% & Purity â‰¥ 70% ë™ì‹œ ë§Œì¡±
- [ ] **SVF ë°œê²¬**: qval < 0.05ì¸ ìœ ì „ì > 100ê°œ
- [ ] **ê³µê°„ íŒ¨í„´**: ìƒìœ„ SVFë“¤ì´ ìƒë¬¼í•™ì ìœ¼ë¡œ íƒ€ë‹¹í•¨

---

---

## ğŸ“‹ íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë³„ ë¡œì§ ìš”ì•½

### ğŸ”„ ì „ì²´ ë°ì´í„° íë¦„

```
ì›ë³¸ Xenium ë°ì´í„° (h5 í˜•ì‹)
         â†“
     [Step 1]
  ì •ê·œí™”, ë¡œê·¸ë³€í™˜, QC
     â†“
  ì •ê·œí™”ëœ ë°œí˜„ í–‰ë ¬ (adata.X)
  + ì„¸í¬ ë©”íƒ€ë°ì´í„° (adata.obs)
  + ì „ì‚¬ì²´ ìœ„ì¹˜ ì •ë³´ (adata.uns['spots'])
         â†“
     [Step 2]
  ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ê³„ì‚° (Euclidean)
     â†“
  {tag}_step2_gene_distances.csv
  ê±°ë¦¬ ë¶„í¬ ë¶„ì„ â†’ ì„¸ê·¸ë©˜í…Œì´ì…˜ í’ˆì§ˆ í‰ê°€
         â†“
     [Step 4]
  ìµœì  í™•ì¥ ê±°ë¦¬ ì‹œë®¬ë ˆì´ì…˜ (0-15 Âµm)
  Capture vs Purity ê³¡ì„  ìƒì„±
     â†“
  {tag}_step4_optimal_expansion.csv
  ìµœì ì  ì„ ì • (Elbow Method)
         â†“
     [Step 5]
  Cellposeë¡œ DAPI ì´ë¯¸ì§€ ë¶„ì„
  Xenium vs AI ì„¸ê·¸ë©˜í…Œì´ì…˜ ë¹„êµ
     â†“
  {tag}_segmentation_overlay_roi.png
  ì¼ì¹˜ë„ í‰ê°€
         â†“
     [Step 8]
  ê³µê°„ ìê¸°ìƒê´€ ë¶„ì„ (SpatialDE)
  Spatially Variable Genes ì„ ë³„
     â†“
  {tag}_step8_svf_spatialde.csv
  ìƒìœ„ SVF ìœ ì „ì ì‹ë³„
```

---

### ê° ë‹¨ê³„ë³„ í•µì‹¬ ë¡œì§

#### **Step 1: ë°ì´í„° ì „ì²˜ë¦¬**

**ëª©í‘œ**: ì›ë³¸ ë°ì´í„°ë¥¼ ë¶„ì„ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ë³€í™˜

**í•µì‹¬ íŒŒë¼ë¯¸í„°**:
```python
min_counts = 10      # ì €í’ˆì§ˆ ì„¸í¬ ì œê±° (empty droplets ë“±)
min_genes = 3        # ê·¹ë„ë¡œ ì €ë°œí˜„ëœ ì„¸í¬ ì œê±°
target_sum = 100     # Xenium íŠ¹ì„± (scRNA-seqëŠ” 10,000)
neighbors = 15       # k-NN ê·¸ë˜í”„ êµ¬ì„±
leiden_resolution = 1.4  # í´ëŸ¬ìŠ¤í„° ìˆ˜ ì¡°ì ˆ
```

**ì…ì¶œë ¥**:
- ì…ë ¥: ì›ë³¸ ì¹´ìš´íŠ¸ í–‰ë ¬ + ì„¸í¬ ìœ„ì¹˜
- ì²˜ë¦¬: í•„í„°ë§ â†’ ì •ê·œí™” â†’ ë¡œê·¸ë³€í™˜ â†’ PCA â†’ Leiden í´ëŸ¬ìŠ¤í„°ë§
- ì¶œë ¥: í´ëŸ¬ìŠ¤í„° í• ë‹¹ëœ ì „ì²˜ë¦¬ AnnData + ì‹œê°í™”

**ì˜ë¯¸**: "ì •ë§ ë¶„ì„í•  ê°€ì¹˜ê°€ ìˆëŠ” ì„¸í¬ë“¤ë§Œ ë‚¨ê¸°ê³ , ë¹„êµ ê°€ëŠ¥í•œ ë°œí˜„ê°’ìœ¼ë¡œ ë³€í™˜"

---

#### **Step 2: ì „ì‚¬ì²´-ì„¸í¬ ê±°ë¦¬ ë¶„ì„**

**ëª©í‘œ**: ì„¸ê·¸ë©˜í…Œì´ì…˜ í’ˆì§ˆ í‰ê°€

**í•µì‹¬ ê³µì‹**:
```
d = âˆš[(x_transcript - x_centroid)Â² + (y_transcript - y_centroid)Â²]
```

**ì˜ë¯¸í•˜ëŠ” ë°”**:
- **ì‘ì€ ê±°ë¦¬** (< 3 Âµm) â†’ ì„¸í¬ ì¤‘ì‹¬ì— ê°€ê¹Œì›€ â†’ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í• ë‹¹
- **í° ê±°ë¦¬** (> 10 Âµm) â†’ ì„¸í¬ ê²½ê³„ ë°”ê¹¥ â†’ ì˜¤í• ë‹¹ ë˜ëŠ” ì„¸ê·¸ë©˜í…Œì´ì…˜ ì˜¤ë¥˜

**ì‚°ì¶œ ë©”íŠ¸ë¦­**:
```
ì¤‘ì•™ê°’: 4.5 Âµm     â†’ "í‰ê· ì ìœ¼ë¡œ ì„¸í¬ ì¤‘ì‹¬ìœ¼ë¡œë¶€í„° 4.5 Âµm"
í‰ê· : 5.2 Âµm       â†’ ëª‡ëª‡ ì´ìƒì¹˜ê°€ ìˆìŒ
í‘œì¤€í¸ì°¨: 2.1 Âµm   â†’ ê±°ë¦¬ì˜ í¸ì°¨ê°€ ì ë‹¹
```

**ì˜ë¯¸**: "ì„¸ê·¸ë©˜í…Œì´ì…˜ì´ ì–¼ë§ˆë‚˜ ì •í™•í•œê°€?"

---

#### **Step 4: ìµœì  í™•ì¥ ê±°ë¦¬ ì°¾ê¸°**

**ê°œë…**: Xenium ê²½ê³„ë¥¼ ë°”ê¹¥ìœ¼ë¡œ í™•ì¥í–ˆì„ ë•Œ ìµœì  ê±°ë¦¬ ì°¾ê¸°

**ë‘ ê°€ì§€ ëª©í‘œì˜ ê· í˜•**:
```
Capture (í¬íšë¥ ) â†‘        Purity (ìˆœë„) â†“
    â–²                        â–¼
    â”‚                        â”‚
 90% â”‚     â•±â•±â•±â•±â•±â•±          â”‚ â•²â•²â•²â•²â•²
    â”‚   â•±â•±â•±â•±            100% â”‚  â•²â•²â•²â•²
    â”‚ â•±â•±â•±â•±â•±                 â”‚    â•²â•²â•²â•²
    â”‚â•±â•±                      â”‚      â•²â•²â•²
  0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0    5   10   15 Âµm        0   5   10  15

    â† ìµœì ì : 6-8 Âµm ê·¼ì²˜ â†’
```

**ìµœì  ê±°ë¦¬ ì„ ì • ê¸°ì¤€**:
1. Capture â‰¥ 80% (ì¶©ë¶„í•œ ì „ì‚¬ì²´ í¬íš)
2. Purity â‰¥ 70% (ì˜¤í• ë‹¹ ìµœì†Œí™”)
3. ë‘ ì¡°ê±´ì„ ë™ì‹œì— ë§Œì¡±í•˜ëŠ” ì²« ê±°ë¦¬

**ì˜ë¯¸**: "ì„¸í¬ ê²½ê³„ë¥¼ ì–¼ë§ˆë‚˜ ë„“í˜€ì•¼ ê°€ì¥ íš¨ìœ¨ì ì¸ê°€?"

---

#### **Step 5: ì„¸ê·¸ë©˜í…Œì´ì…˜ ë²¤ì¹˜ë§ˆí¬**

**ë¹„êµ í•­ëª©**:
```
Xenium ê¸°ë²•:           Cellpose ê¸°ë²•:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê¸°ê¸° ë‚´ì¥ ì•Œê³ ë¦¬ì¦˜     AI ê¸°ë°˜ ë”¥ëŸ¬ë‹
í˜•ê´‘ ì´ë¯¸ì§€ ê¸°ë°˜       DAPIë§Œ ì‚¬ìš©
ìë™í™” (ë¹ ë¦„)         ìˆ˜ë™ íŒŒë¼ë¯¸í„° ì¡°ì •
ì„¸í¬-ìœ ì „ì ì •í™•ë„     í•µ í˜•íƒœ ì •í™•ë„
```

**ì¶œë ¥ ë¹„êµ**:
```
Xenium: 5,240 ì„¸í¬ ê°ì§€
Cellpose: 5,180 ì„¸í¬ ê°ì§€
Overlap: 4,890 ì„¸í¬ (ì¼ì¹˜ë„ 93%)

â†’ "ë‘ ë°©ë²• ëª¨ë‘ ë¹„ìŠ·í•œ ê²°ê³¼ (ì‹ ë¢°í•  ìˆ˜ ìˆìŒ)"
```

**ì˜ë¯¸**: "ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œë„ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ”ê°€?"

---

#### **Step 8: ê³µê°„ ë³€ì´ ìœ ì „ì (SVF)**

**ì§ˆë¬¸**: "ì–´ë–¤ ìœ ì „ìê°€ ê³µê°„ìƒ í´ëŸ¬ìŠ¤í„°ë§ì„ ë³´ì´ëŠ”ê°€?"

**ì•Œê³ ë¦¬ì¦˜**: Moran's I (ê³µê°„ ìê¸°ìƒê´€)

**ìˆ˜ì‹**:
```
I = (ê³µê°„ ê°€ì¤‘ì¹˜ í–‰ë ¬) Ã— (ë°œí˜„ê°’ í¸ì°¨)
  / (ë°œí˜„ ë¶„ì‚°)

ê°’ì´ 1ì— ê°€ê¹Œì›€ â†’ ê°•í•œ í´ëŸ¬ìŠ¤í„°ë§ (ë¹„ìŠ·í•œ ì„¸í¬ë“¤ì´ ì¸ì ‘)
ê°’ì´ 0 ê·¼ì²˜ â†’ ë¬´ì‘ìœ„ ë¶„í¬ (ê³µê°„ íŒ¨í„´ ì—†ìŒ)
ê°’ì´ -1ì— ê°€ê¹Œì›€ â†’ ì²´í¬ íŒ¨í„´ (ë‹¤ë¥¸ ì„¸í¬ë“¤ì´ ì¸ì ‘)
```

**ì‹¤ì œ í•´ì„**:
```
SVF ìœ ì „ì (ERBB2, HER2, GATA3):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ê°™ì€ ìƒ‰ í´ëŸ¬ìŠ¤í„° â†’ ê°™ì€ ìœ ì „ìí˜• ì„¸í¬ ì¸ì ‘
â†’ "ì¢…ì–‘ íŠ¹ì • ìœ ì „ìë“¤ì´ ì¢…ì–‘ ì˜ì—­ì— ì§‘ì¤‘"

SVF ì•„ë‹˜ (GAPDH, í•˜ìš°ìŠ¤í‚¤í•‘ ìœ ì „ì):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ëœë¤ ë¶„í¬ â†’ ëª¨ë“  ì„¸í¬ì—ì„œ ê°™ì€ ìˆ˜ì¤€ìœ¼ë¡œ ë°œí˜„
â†’ "ìƒì¡´ì— í•„ìˆ˜ì ì´ë¯€ë¡œ ëª¨ë“  ì„¸í¬ì—ì„œ í•„ìš”"
```

**ì˜ë¯¸**: "ì–´ë–¤ ìœ ì „ìê°€ ì¡°ì§ êµ¬ì¡°ë¥¼ ì •ì˜í•˜ëŠ”ê°€?"

---

## ğŸ¯ ì‹¤ì œ ë¶„ì„ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ìœ ë°©ì•” ì¢…ì–‘ ë¶„ì„

**ì˜ˆìƒ ê²°ê³¼**:
```
Step 1 (í´ëŸ¬ìŠ¤í„°ë§):
- Cluster 0: ERBB2â†‘ GATA3â†‘ â†’ ì¢…ì–‘ ì„¸í¬ (Luminal A)
- Cluster 1: MYCâ†‘ â†’ ì¢…ì–‘ ì„¸í¬ (Basal-like)
- Cluster 2: CDH1â†‘ EPCAMâ†‘ â†’ ì •ìƒ ìƒí”¼ ì„¸í¬
- Cluster 3: COL1A1â†‘ VIMâ†‘ â†’ ê²°í•©ì¡°ì§ ì„¬ìœ ëª¨ì„¸í¬

Step 2 (ê±°ë¦¬ ë¶„ì„):
- ì¤‘ì•™ê°’: 3.2 Âµm
- í•´ì„: ìš°ìˆ˜í•œ ì„¸ê·¸ë©˜í…Œì´ì…˜ (ì¢…ì–‘ ê²½ê³„ ëª…í™•)

Step 4 (ìµœì  ê±°ë¦¬):
- ê¶Œì¥: 4.0 Âµm
- Capture: 82%, Purity: 85%
- í•´ì„: ê· í˜•ì¡íŒ ì¡°ê±´

Step 8 (SVF):
- ìƒìœ„ ìœ ì „ì: ERBB2, HER2, GATA3, MUC1, KRT19
- í•´ì„: ì¢…ì–‘ í‘œì§€ìë“¤ì´ ê³µê°„ìƒ í´ëŸ¬ìŠ¤í„°ë§
  â†’ ì¢…ì–‘ ë‚´ë¶€ ë™ì§ˆì„± ë†’ìŒ
  â†’ ì¹˜ë£Œ íƒ€ê²ŸíŒ… ê°€ëŠ¥
```

**ìƒë¬¼í•™ì  í•´ì„**:
"ì´ ì¢…ì–‘ì€ ê³µê°„ì ìœ¼ë¡œ ê· ì§ˆí•œ Luminal A íŠ¹ì„±ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ERBB2 ê³¼ë°œí˜„ì´ ëšœë ·í•¨"

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì‹ ê²½ ì¡°ì§ ë¶„ì„

**ì˜ˆìƒ ê²°ê³¼**:
```
Step 1 (í´ëŸ¬ìŠ¤í„°ë§):
- Cluster 0: SOX2â†‘ â†’ ì‹ ê²½ ì¤„ê¸°ì„¸í¬ (ì£¼ë¡œ ë°°ìª½)
- Cluster 1: TUBB3â†‘ NEFLâ†‘ â†’ ë‰´ëŸ° (ì£¼ë¡œ í‘œì¸µ)
- Cluster 2: S100Bâ†‘ GFAPâ†‘ â†’ ì„±ìƒêµì„¸í¬ (ì „ì—­)

Step 2 (ê±°ë¦¬ ë¶„ì„):
- ì¤‘ì•™ê°’: 5.8 Âµm
- í•´ì„: ì–‘í˜¸í•œ ì„¸ê·¸ë©˜í…Œì´ì…˜ (ì‹ ê²½ì¡°ì§ êµ¬ì¡° ë³µì¡)

Step 4 (ìµœì  ê±°ë¦¬):
- ê¶Œì¥: 6.5 Âµm
- Capture: 85%, Purity: 72%
- í•´ì„: ì‹ ê²½ ì¡°ì§ì˜ 3D êµ¬ì¡°ìƒ ì•½ê°„ì˜ ì˜¤í• ë‹¹ ì¡´ì¬

Step 8 (SVF):
- ìƒìœ„ ìœ ì „ì: PAX6, NEUROLIGIN, NEUROGRANIN, GRIN1
- í•´ì„: ì‹ ê²½ ë°œë‹¬ ìœ ì „ìë“¤ì´ ì‹ ê²½ ì¸µ(layer)ê³¼ ì¼ì¹˜
  â†’ "6ì¸µ êµ¬ì¡°ê°€ ìœ ì „ì ë°œí˜„ìœ¼ë¡œ ëª…í™•íˆ ë¶„ë¦¬ë¨"
```

**ìƒë¬¼í•™ì  í•´ì„**:
"ì‹ ê²½ í”¼ì§ˆì˜ ê³„ì¸µ êµ¬ì¡°ê°€ ë¶„ì ìˆ˜ì¤€ì—ì„œ ì˜ ë³´ì¡´ë˜ì–´ ìˆìœ¼ë©°, ì‹ ê²½ ë°œë‹¬ ë§ˆì»¤ë“¤ì´ ê° ì¸µì— íŠ¹ì´ì "

---

## ğŸ”§ íŒŒë¼ë¯¸í„° íŠœë‹ ê°€ì´ë“œ

**ìƒí™©ë³„ ê¶Œì¥ ì„¤ì •**:

### ë°ì´í„° í’ˆì§ˆ ë‚®ì€ ê²½ìš°
```python
min_counts = 5      # ë” ê´€ëŒ€í•œ í•„í„°
min_genes = 2
target_sum = 100    # ê·¸ëŒ€ë¡œ
neighbors = 10      # ë” ì§€ì—­ì  ê·¸ë˜í”„
leiden_resolution = 1.0  # ë” í° í´ëŸ¬ìŠ¤í„°
```

### ë°ì´í„° í’ˆì§ˆ ë†’ì€ ê²½ìš°
```python
min_counts = 20     # ë” ì—„ê²©í•œ í•„í„°
min_genes = 5
target_sum = 100
neighbors = 20      # ë” ê¸€ë¡œë²Œí•œ ê·¸ë˜í”„
leiden_resolution = 1.8  # ë” ì„¸ë¶„í™”ëœ í´ëŸ¬ìŠ¤í„°
```

### ì„¸ê·¸ë©˜í…Œì´ì…˜ ë¶ˆí™•ì‹¤í•œ ê²½ìš°
```python
# Step 2 ê±°ë¦¬ ë¶„ì„ â†’ ì¤‘ì•™ê°’ > 7 Âµm
â†’ Step 4ì—ì„œ ë†’ì€ Purity ìš°ì„ 
â†’ í™•ì¥ ê±°ë¦¬ ì‘ê²Œ ì„¤ì • (ë³´ìˆ˜ì )
```

### ì„¸ê·¸ë©˜í…Œì´ì…˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê²½ìš°
```python
# Step 2 ê±°ë¦¬ ë¶„ì„ â†’ ì¤‘ì•™ê°’ < 3 Âµm
â†’ Step 4ì—ì„œ ë†’ì€ Capture ìš°ì„ 
â†’ í™•ì¥ ê±°ë¦¬ í¬ê²Œ ì„¤ì • (í¬ê´„ì )
```

---

## ğŸ“š ì°¸ê³  ë¬¸í—Œ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬

**í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬**:
- `scanpy`: ë‹¨ì„¸í¬/ê³µê°„ ì „ì‚¬ì²´ ë¶„ì„ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬
- `SpatialDE`: ê³µê°„ ë³€ì´ ìœ ì „ì ì‹ë³„
- `Cellpose`: AI ê¸°ë°˜ ì„¸ê·¸ë©˜í…Œì´ì…˜
- `pandas`, `numpy`: ë°ì´í„° ì²˜ë¦¬
- `matplotlib`, `seaborn`: ì‹œê°í™”

**ì£¼ìš” ì•Œê³ ë¦¬ì¦˜**:
- Leiden Clustering: ë” ë¹ ë¥´ê³  ì•ˆì •ì ì¸ Louvain ë²„ì „
- Moran's I: ê³µê°„ ìê¸°ìƒê´€ í†µê³„ëŸ‰
- PCA + k-NN: ì°¨ì› ì¶•ì†Œ ë° ì´ì›ƒ ê·¸ë˜í”„
- Euclidean Distance: ê³µê°„ìƒ ê±°ë¦¬ ê³„ì‚°

**ë…¼ë¬¸**:
- Xenium ë²¤ì¹˜ë§ˆí‚¹ ë…¼ë¬¸ (target_sum=100 ê¶Œì¥)
- SpatialDE ì›ë…¼ë¬¸ (ê³µê°„ ë¶„ì„ ë°©ë²•ë¡ )
- Leiden ì•Œê³ ë¦¬ì¦˜ (Traag et al., 2019)
